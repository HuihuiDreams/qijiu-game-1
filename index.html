<!--
/**
 * @license
 * Copyright (C) 2026 [å²³æ¸…æºæ²ˆæ¸…ç§‹ç»“å©šæ¨è¿›åä¼š]. All Rights Reserved.
 * * ã€ç‰ˆæƒå£°æ˜ä¸ä½¿ç”¨è®¸å¯ã€‘
 * 1. æœ¬ä½œå“ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºä»£ç æ¶æ„ã€è„šæœ¬é€»è¾‘ã€ç¾æœ¯èµ„æºã€å‰§æœ¬æ–‡å­—ï¼‰ç‰ˆæƒå½’åˆ¶ä½œç»„æ‰€æœ‰ã€‚
 * 2. ä¸¥ç¦ä»»ä½•å½¢å¼çš„æœªç»æˆæƒçš„äºŒæ¬¡åˆ†å‘ã€ä¿®æ”¹ã€åç¼–è¯‘æˆ–æ‹†åŒ…è¡Œä¸ºã€‚
 * 3. æœ¬é¡¹ç›®ä»£ç å…·æœ‰å¼ºçƒˆçš„åŸåˆ›æ€§ä¸ç‰¹å®šè§’è‰²æŒ‡å‘æ€§ï¼ˆå²³æ¸…æºÃ—æ²ˆæ¸…ç§‹ï¼ˆåŸä¸»æ²ˆä¹ï¼Œéæ²ˆå£ï¼‰ï¼‰ï¼Œ
 * ä¸¥ç¦å°†å…¶ç”¨äºå…¶ä»–è§’è‰²é…å¯¹ï¼ˆCPï¼‰æˆ–å•†ä¸šç”¨é€”ã€‚
 * 4. ä»»ä½•æœªç»è®¸å¯çš„ç›—ç”¨è¡Œä¸ºï¼Œåˆ¶ä½œç»„ä¿ç•™è¿½ç©¶å…¶æ³•å¾‹è´£ä»»åŠå…¬å¼€ç»´æƒçš„æƒåˆ©ã€‚
 * * Project: [å®‰å®šå³°é‡‡è´­å‡è¯å¼•å‘çš„æƒ¨æ¡ˆ]
 * Developers: @ç°ç°(Program), @æ•°æ®(Art), @ç°ç°(Script)
 */
-->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å®‰å®šå³°é‡‡è´­å‡è¯å¼•å‘çš„æƒ¨æ¡ˆ VNé£</title>
    <meta name="description" content="ä¸€ä¸ªå…³äºä¿®ä»™ç•Œä¸¹è¯ä¸çˆ±æ¨æƒ…ä»‡çš„è§†è§‰å°è¯´ã€‚">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.loli.net/css2?family=Inter:wght@400;700&family=Noto+Serif+SC:wght@400;700&family=Ma+Shan+Zheng&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d1a;
            overscroll-behavior: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .font-serif-sc {
            font-family: 'Noto Serif SC', serif;
        }

        .font-calligraphy {
            font-family: 'Ma Shan Zheng', cursive;
        }

        /* åŠ¨ç”»ä¸ç‰¹æ•ˆ */
        .fade-enter {
            opacity: 0;
        }

        .fade-enter-active {
            opacity: 1;
            transition: opacity 500ms ease-in;
        }

        .fade-exit {
            opacity: 1;
        }

        .fade-exit-active {
            opacity: 0;
            transition: opacity 300ms ease-in;
        }

        .dialogue-glass {
            background: rgba(13, 13, 26, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-top: 1px solid rgba(103, 232, 249, 0.3);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
        }

        /* æ»šåŠ¨æ¡ */
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: rgba(103, 232, 249, 0.3);
            border-radius: 4px;
        }

        /* è§’è‰²ç«‹ç»˜ä½ç½®è°ƒæ•´ */
        .char-sprite {
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.3));
        }

        /* å±å¹•éœ‡åŠ¨åŠ¨ç”» */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0) translateY(0);
            }

            10% {
                transform: translateX(-8px) translateY(-2px) rotate(-0.5deg);
            }

            20% {
                transform: translateX(8px) translateY(2px) rotate(0.5deg);
            }

            30% {
                transform: translateX(-6px) translateY(-1px) rotate(-0.3deg);
            }

            40% {
                transform: translateX(6px) translateY(1px) rotate(0.3deg);
            }

            50% {
                transform: translateX(-4px) translateY(-1px) rotate(-0.2deg);
            }

            60% {
                transform: translateX(4px) translateY(1px) rotate(0.2deg);
            }

            70% {
                transform: translateX(-2px) translateY(0) rotate(-0.1deg);
            }

            80% {
                transform: translateX(2px) translateY(0) rotate(0.1deg);
            }

            90% {
                transform: translateX(-1px) translateY(0);
            }
        }

        .screen-shake {
            animation: shake 0.6s ease-in-out;
        }

        /* æœ‰èŠ‚å¥çš„æŒç»­éœ‡åŠ¨åŠ¨ç”» */
        @keyframes rhythm-shake {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(3px);
            }
        }

        .screen-rhythm {
            animation: rhythm-shake 0.5s ease-in-out infinite;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šç¡®ä¿å…¨å± */
        #app-root {
            height: 100vh;
            /* fallback */
            height: 100dvh;
        }

        /* æ‰‹æœºæ¨ªå±ä¸“ç”¨æ ·å¼ - å…¨å±€ä½œç”¨åŸŸ */
        @media (max-height: 500px) and (orientation: landscape) {
            .mobile-landscape-title {
                font-size: 1.8rem !important;
                line-height: 1.2 !important;
            }

            .mobile-landscape-btn {
                padding-top: 0.3rem !important;
                padding-bottom: 0.3rem !important;
                font-size: 1rem !important;
            }

            .mobile-landscape-gap {
                gap: 0.5rem !important;
                margin-top: 0.5rem !important;
            }

            /* Ending Screen ç‰¹å®šæ ·å¼ - ä½¿ç”¨ç»å¯¹å®šä½å¸ƒå±€é¿å…å¼¹æ€§ç›’å¡Œé™· */
            .ending-title-mobile-landscape {
                position: absolute !important;
                top: 0.5rem !important;
                left: 0 !important;
                width: 100% !important;
                margin: 0 !important;
                font-size: 1.2rem !important;
                line-height: 1.1 !important;
                z-index: 10 !important;
            }

            .ending-text-mobile-landscape {
                position: absolute !important;
                top: 3rem !important;
                bottom: 3rem !important;
                left: 5% !important;
                width: 90% !important;
                margin: 0 !important;
                padding: 0.5rem !important;
                font-size: 0.75rem !important;
                line-height: 1.5 !important;
                overflow-y: auto !important;
                max-height: none !important;
                flex-grow: 0 !important;
                height: auto !important;
                background: transparent !important;
                /* é€æ˜èƒŒæ™¯ */
                border: none !important;
                /* å»é™¤è¾¹æ¡† */
                z-index: 10 !important;
                display: flex !important;
                align-items: center !important;
                /* å‚ç›´å±…ä¸­ */
                justify-content: center !important;
                text-align: left !important;
                /* æ°´å¹³å·¦å¯¹é½ */
            }

            .ending-btn-mobile-landscape {
                position: absolute !important;
                bottom: 0.5rem !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                margin: 0 !important;
                font-size: 0.75rem !important;
                padding: 0.25rem 1.5rem !important;
                z-index: 10 !important;
                white-space: nowrap !important;
            }

            .ending-container-mobile-landscape {
                display: block !important;
                position: relative !important;
                width: 100% !important;
                height: 100% !important;
                padding: 0 !important;
                justify-content: unset !important;
                align-items: unset !important;
            }

            /* æ‰‹æœºæ¨ªå±ï¼šå¯¹è¯æ¡†è¿›ä¸€æ­¥å‹ç¼© */
            .dialogue-glass {
                height: 4.8rem !important;
                /* Slightly increased height */
                padding: 0.4rem 0.6rem !important;
                /* Increased padding */
            }

            .dialogue-glass>div:first-child {
                padding-top: 0 !important;
            }

            .dialogue-glass p {
                font-size: 0.8rem !important;
                line-height: 1.3 !important;
                margin-top: -0.1rem !important;
            }

            /* æ‰‹æœºæ¨ªå±ï¼šéšè—èœå•æ–‡å­— */
            .menu-label {
                display: none !important;
            }

            /* æ‰‹æœºæ¨ªå±ï¼šéŸ³é‡æŒ‰é’®ä½ç½®è°ƒæ•´ */
            .volume-btn-mobile {
                top: 0.2rem !important;
                right: 0.2rem !important;
                padding: 0.25rem !important;
            }

            /* æ‰‹æœºæ¨ªå±ï¼šå¿«æ·èœå•ä½ç½®è°ƒæ•´ */
            .mobile-landscape-bottom-adjust {
                bottom: 5rem !important;
                right: 0.5rem !important;
                gap: 0.5rem !important;
            }

            /* æ‰‹æœºæ¨ªå±ï¼šå­˜æ¡£ç•Œé¢å¼ºåˆ¶2åˆ— */
            .mobile-landscape-grid-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
            }
        }

        /* ğŸš« é˜²ç›—å¢å¼ºï¼šç¦æ­¢å›¾ç‰‡æ‹–æ‹½å’Œé•¿æŒ‰ */
        img {
            pointer-events: none;
            /* è®©ç‚¹å‡»ç©¿é€è‡³çˆ¶å®¹å™¨ï¼Œé˜²æ­¢é•¿æŒ‰å•ç‹¬é€‰ä¸­å›¾ç‰‡ */
            -webkit-user-drag: none;
            /* ç¦æ­¢æ‹–æ‹½ */
            user-select: none;
            -webkit-touch-callout: none;
            /* ç¦æ­¢iOSé•¿æŒ‰èœå• */
        }

        /* å…¨å±€ç¦æ­¢ç§»åŠ¨ç«¯é•¿æŒ‰ç³»ç»Ÿèœå• */
        body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            /* å…¨å±€ç¦æ­¢é€‰æ‹©æ–‡æœ¬ï¼ˆå¯é€‰ï¼Œå¢å¼ºä¿æŠ¤ï¼‰ */
            user-select: none;
        }
    </style>
</head>

<body class="text-slate-100 overflow-hidden">
    <div id="app-root"></div>

    <!-- Code Protection & Copyright Warnings -->
    <script>
        (function () {
            // ä»…åœ¨éæœ¬åœ°ç¯å¢ƒå¯ç”¨ä¿æŠ¤ï¼Œä»¥å…å½±å“å¼€å‘è°ƒè¯•
            // If you want to test this locally, comment out the check below
            const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

            // Console Warning (Always show copyright)
            const K = ' [å²³æ¸…æºæ²ˆæ¸…ç§‹ç»“å©šæ¨è¿›åä¼š] ';
            const styleTitle = 'color: #ef4444; font-size: 30px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); font-family: "Noto Serif SC", serif;';
            const styleBody = 'color: #94a3b8; font-size: 14px; line-height: 1.5; font-family: sans-serif;';
            const styleCopy = 'color: #67e8f9; font-size: 12px; font-style: italic;';

            console.log(`%cğŸ›‘ è­¦å‘Šï¼STOP!`, styleTitle);
            console.log(`%cæ­¤åŒºåŸŸä¸“ä¸ºå¼€å‘è€…è°ƒè¯•ä½¿ç”¨ã€‚å¦‚æœæ‚¨è¢«å‘ŠçŸ¥åœ¨æ­¤å¤„ç²˜è´´ä»»ä½•ä»£ç ä»¥â€œè§£é”éšè—ç»“å±€â€æˆ–â€œè·å¾—ç‰¹æ®Šé“å…·â€ï¼Œé‚£æ˜¯ä¸€ä¸ªéª—å±€ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‚¨çš„å­˜æ¡£ä¸¢å¤±æˆ–æ•°æ®æ³„éœ²ã€‚`, styleBody);
            console.log(`%c\næœ¬ä½œå“ä»£ç åŠå‰§æœ¬ç‰ˆæƒå½’${K}æ‰€æœ‰ã€‚\nä¸¥ç¦ä»»ä½•å½¢å¼çš„æœªç»æˆæƒçš„æ¬è¿ã€ä¿®æ”¹æˆ–å•†ä¸šä½¿ç”¨ã€‚\n\nCopyright (C) 2026${K}. All Rights Reserved.`, styleCopy);

            // UX Deterrents (Skip on localhost)
            if (isLocal) {
                console.log('%cğŸ›¡ï¸ å¼€å‘æ¨¡å¼ï¼šå·²è‡ªåŠ¨ç¦ç”¨é˜²å¤åˆ¶/é˜²è°ƒè¯•ä¿æŠ¤', 'color: #4ade80; font-weight: bold;');
                return;
            }

            // 1. Disable Context Menu (Right Click)
            document.addEventListener('contextmenu', e => {
                e.preventDefault();
                return false;
            });

            // 2. Disable Keyboard Shortcuts
            document.addEventListener('keydown', e => {
                // F12
                if (e.key === 'F12') {
                    e.preventDefault();
                    return false;
                }
                // Ctrl+Shift+I / Ctrl+Shift+J / Ctrl+Shift+C (DevTools)
                if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i' || e.key === 'J' || e.key === 'j' || e.key === 'C' || e.key === 'c')) {
                    e.preventDefault();
                    return false;
                }
                // Ctrl+U (View Source)
                if (e.ctrlKey && (e.key === 'U' || e.key === 'u')) {
                    e.preventDefault();
                    return false;
                }
                // Ctrl+S (Save Page)
                if (e.ctrlKey && (e.key === 'S' || e.key === 's')) {
                    e.preventDefault();
                    return false;
                }
            });

            // 3. Disable Drag/Select (Optional, enforced by CSS user-select: none usually)
            document.addEventListener('dragstart', e => e.preventDefault());
        })();
    </script>

    <!-- ä½¿ç”¨ ES Modules ç›´æ¥åŠ è½½ Preact å’Œ htm -->
    <script type="module">


        // ä½¿ç”¨ esm.sh ç¡®ä¿ä¾èµ–ç‰ˆæœ¬ä¸€è‡´æ€§å’Œæ­£ç¡®çš„ ESM å¯¼å‡º
        import { h, render, createContext } from 'https://esm.sh/preact@10.19.3';
        import { useState, useEffect, useRef, useMemo, useContext } from 'https://esm.sh/preact@10.19.3/hooks';
        import htm from 'https://esm.sh/htm@3.1.1';

        const html = htm.bind(h);

        // --- Storage å·¥å…·æ¨¡å— (å®‰å…¨çš„ localStorage å°è£…) ---
        const Storage = {
            set: (key, value, retryCount = 0) => {
                // é˜²æ­¢æ— é™é€’å½’ï¼Œæœ€å¤šé‡è¯•3æ¬¡
                const MAX_RETRY = 3;
                
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return { success: true };
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        // å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå°è¯•æ¸…ç†æœ€æ—§çš„å­˜æ¡£
                        if (retryCount >= MAX_RETRY) {
                            console.warn('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå·²å°è¯•æ¸…ç†ä½†ä»æœ‰é—®é¢˜');
                            return { success: false, error: 'QuotaExceededError' };
                        }
                        
                        try {
                            const keys = Object.keys(localStorage)
                                .filter(k => k.startsWith('qijiu_save_slot_'))
                                .map(k => {
                                    try {
                                        const itemData = JSON.parse(localStorage.getItem(k));
                                        return {
                                            key: k,
                                            data: itemData,
                                            timestamp: itemData?.timestamp || 0
                                        };
                                    } catch {
                                        return { key: k, data: null, timestamp: 0 };
                                    }
                                })
                                .filter(item => item.data !== null)
                                .sort((a, b) => a.timestamp - b.timestamp);
                            
                            if (keys.length > 0) {
                                localStorage.removeItem(keys[0].key);
                                // é‡è¯•ä¿å­˜ï¼Œå¢åŠ é‡è¯•è®¡æ•°
                                return Storage.set(key, value, retryCount + 1);
                            }
                        } catch (cleanupError) {
                            console.error('æ¸…ç†å­˜æ¡£æ—¶å‡ºé”™:', cleanupError);
                        }
                        console.warn('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œä¸”æ— æ³•æ¸…ç†æ—§æ•°æ®');
                        return { success: false, error: 'QuotaExceededError' };
                    } else if (e.name === 'SecurityError') {
                        console.warn('éšç§æ¨¡å¼ä¸‹æ— æ³•ä½¿ç”¨ localStorage');
                        return { success: false, error: 'SecurityError' };
                    } else {
                        console.error('Storage error:', e);
                        return { success: false, error: e.name || 'UnknownError' };
                    }
                }
            },
            get: (key, defaultValue = null) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (e) {
                    console.error('Storage read error:', e);
                    return defaultValue;
                }
            },
            remove: (key) => {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    console.error('Storage remove error:', e);
                    return false;
                }
            }
        };

        // --- èµ„æºé…ç½® (ä¿æŒåŸèµ„æº) ---
        const ASSETS = {
            bg: {
                // qingjing: './bk.JPG',
                qiancao: './qiancao.jpg',
                bamboo: './bamboonight.jpg',
                coldspring: './coldspring.jpg',
                bedroom: './bedroom.jpg',
                ruin: './ruin.jpg',
                lingxi: './lingxicave.jpg',
                nuanhong: './nuanhongge.jpg',
                start: './qijiu_start_screen (1).jpg',
                endingB: './Image (1).png'
            },
            char: {
                sqq: {
                    v1: './sqq_1.png',        // 1. æ­£å¸¸ (ç”¨äº angry, disdain, default)
                    v2: './sqq_2.png',        // 2. é—­çœ¼ (ç”¨äº despair)
                    v3: './sqq_3.png',        // 3. é—­çœ¼è„¸çº¢ (ç”¨äº pain - è¯æ€§ç—›è‹¦)
                    v4: './sqq_4.png',        // 4. ç›®å…‰èº²é—ª (ç”¨äº shocked, soft - éœ‡æƒŠ/å¿ƒè™š/å‚²å¨‡)
                    v5: './sqq_5.png'         // 5. ç›®å…‰èº²é—ª+è„¸çº¢ (ç”¨äº shame - ç¾è€»/æƒ…åŠ¨)
                },
                yqy: './yueqingyuan.png'
            },
            audio: {
                bgm: './baheng.mp3',
                boom: './boom.mp3',
                fan: './fan.mp3',
                splash: './splash.mp3',
                cloth: './cloth.mp3',
                sword: './sword.mp3',
                magic: './magic.mp3',
                pipa: './pipa.mp3'
            }
        };

        // --- å‰§æœ¬æ•°æ® (Structure Refined) ---
        const SCENES = {
            'chapter1': {
                lines: [
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆæ‰‹ä¸­æŠ˜æ‰‡â€œå•ªâ€åœ°åˆä¸Šï¼Œçœ‰é—´èšç€æˆ¾æ°”ï¼‰æ²¡æœ‰ï¼Ÿæœ¨å¸ˆå¼Ÿï¼Œä½ åƒè‰å³°å·ç§°æ±‡é›†å¤©ä¸‹çµè¯ï¼Œå¦‚ä»Šæˆ‘è¦èƒ½åŠ©æˆ‘ç»“ä¸¹çªç ´çš„è¯ï¼Œä½ å´æ¨ä¸‰é˜»å››ï¼Ÿ", mood: 'angry', bg: ASSETS.bg.qiancao, sound: ASSETS.audio.fan },
                    { speaker: 'æœ¨æ¸…èŠ³', text: "æ²ˆå¸ˆå…„ï¼Œå¹¶éå¸ˆå¼Ÿä¸ç»™ã€‚åªæ˜¯ä¿®è¡Œè®²ç©¶å¾ªåºæ¸è¿›ã€‚è‹¥ç”¨çŒ›è¯å¼ºè¡Œæ‹”é«˜ï¼Œåªæ€•æ¬²é€Ÿåˆ™ä¸è¾¾ã€‚", mood: 'neutral' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†·ç¬‘ä¸€å£°ï¼‰æ¬²é€Ÿåˆ™ä¸è¾¾ï¼Ÿæˆ‘çœ‹æŸ³æ¸…æ­Œç²¾è¿›ç¥é€Ÿï¼Œä¹Ÿæ²¡è§ä»–å‡ºä»€ä¹ˆå²”å­ã€‚æ€ä¹ˆï¼Œä»–æ˜¯å¤©ä¹‹éª„å­ï¼Œæˆ‘å°±æ˜¯æœ½æœ¨ä¸€å—ï¼Ÿ", mood: 'angry' },
                    { speaker: 'æœ¨æ¸…èŠ³', text: "ï¼ˆå¹æ°”ï¼Œå–å‡ºè´´ç€ç¬¦ç®“çš„é’ç“·å°ç“¶ï¼‰è¿™æ˜¯æ–°ç‚¼çš„â€œå›ºå…ƒç´«é‡‘ä¸¹â€ã€‚æ­¤è¯æ€§çƒˆï¼Œèƒ½çŸ­æ—¶é—´æ¿€å‘æ½œèƒ½â€¦â€¦", mood: 'worried' },
                    { speaker: 'æœ¨æ¸…èŠ³', text: "ä¸è¿‡å¸ˆå¼Ÿå¿…é¡»è¨€æ˜ï¼Œè¿™æ‰¹è¯çš„å‡ å‘³è¾…æ–™æ˜¯å®‰å®šå³°æ–°è¿›çš„ï¼Œå°šå¸ˆå…„è™½ä¿¡èª“æ—¦æ—¦è¯´æ˜¯ä¸Šå“ï¼Œä½†æˆ‘å°šæœªå®Œå…¨éªŒè¿‡è¯æ€§â€¦â€¦", mood: 'worried' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆä¸€æŠŠå¤ºè¿‡è¯ç“¶ï¼‰å¤Ÿäº†ã€‚åªè¦æœ‰ç”¨å°±è¡Œã€‚", mood: 'angry' },
                    { speaker: 'æ—ç™½', text: "ä»–æ— æ³•å¿å—åŒè¾ˆå¸ˆå…„å¼Ÿéƒ½å…ˆä»–ç»“ä¸¹ã€‚ä»–è¦å˜å¼ºï¼Œå“ªæ€•é¥®é¸©æ­¢æ¸´ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å¤œæ·±äº†ï¼Œæ¸…é™å³°ç«¹èˆã€‚ç«¹æ—åœ¨é£ä¸­æ²™æ²™ä½œå“ã€‚æ²ˆæ¸…ç§‹å±é€€ä¼—å¼Ÿå­ï¼Œè®¾ä¸‹ä¸¤é“ç¦åˆ¶ï¼Œä»°å¤´å°†é‚£é¢—ç´«é‡‘ä¸¹è¯åå…¥è…¹ä¸­ã€‚", mood: 'narrative', bg: ASSETS.bg.bamboo },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆé—·å“¼ä¸€å£°ï¼Œé¢å¤´æ¸—å‡ºå†·æ±—ï¼‰å””â€¦â€¦", mood: 'pain' },
                    { speaker: 'æ—ç™½', text: "é‚£ç«æ²¡çƒ§åœ¨ç»è„‰ï¼Œå…¨çƒ§è¿›äº†éª¨é«“è¡€æ¶²ï¼Œç›´å†²å°è…¹ï¼Œå¸¦ç€éš¾ä»¥è¨€å–»åˆä»¤äººç¾è€»çš„ç‡¥çƒ­ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆèœ·ç¼©èµ·èº«å­ï¼Œæ‰‹æŒ‡æ­»æŠ“èº«ä¸‹ç«¹å¸­ï¼‰è¯¥æ­»â€¦â€¦æœ¨æ¸…èŠ³â€¦â€¦å°šæ¸…åâ€¦â€¦", mood: 'shame' },
                    { speaker: 'æ—ç™½', text: "èº«ä½“åƒè¢«ä¸‡èšå™¬å’¬ï¼Œåˆç—’åˆç—›ï¼Œæ›´å¯æ€•çš„æ˜¯é‚£ç§æ·±å¤„æ³›ä¸Šæ¥çš„ç©ºè™šæ„Ÿã€‚", mood: 'narrative' },
                    { speaker: 'å²³æ¸…æº', text: "æ¸…ç§‹å¸ˆå¼Ÿï¼Ÿæˆ‘åˆšå¾—äº†äº›æå¥½çš„é›¨å‰é¾™äº•ï¼Œæƒ³ç€ä½ åº”è¯¥è¿˜æ²¡æ­‡â€¦â€¦", mood: 'gentle' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆæµ‘èº«ä¸€åƒµï¼Œæ­»æ­»å’¬ä½å˜´å”‡ï¼‰ï¼ˆå†…å¿ƒï¼‰å²³æ¸…æºã€‚ç»ä¸èƒ½è®©ä»–çœ‹è§è‡ªå·±è¿™å‰¯æ¨¡æ ·ï¼ç»ä¸ï¼æ»šâ€¦â€¦", mood: 'shame' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆå£°éŸ³æŸ“ä¸Šç„¦æ€¥ï¼‰æ¸…ç§‹å¸ˆå¼Ÿï¼Ÿä½ æ€ä¹ˆäº†ï¼Ÿæˆ‘è¿›æ¥äº†ï¼", mood: 'worried' },
                    { speaker: 'æ—ç™½', text: "ã€éŸ³æ•ˆã€‘ç °ï¼çµåŠ›ç ´é—¨ã€‚", mood: 'system', sound: ASSETS.audio.boom, shake: true },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆå‡ æ­¥å†²åˆ°æ¦»å‰ï¼‰è¿™å‘³é“â€¦â€¦åˆæ¬¢å®—çš„åƒæœºæ•£ï¼Ÿï¼å°ä¹ï¼", mood: 'shocked' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆçœ¼ç¥æ¶£æ•£ï¼Œç—›è‹¦åœ°æ’•æ‰¯é¢†å£ï¼‰åˆ«â€¦â€¦åˆ«ç¢°æˆ‘â€¦â€¦", mood: 'shame' },
                ],
                next: 'chapter2'
            },
            'chapter2': {
                lines: [
                    { speaker: 'æ—ç™½', text: "å¯’æ½­å†·æ³‰ã€‚å²³æ¸…æºæŠ±ç€æ²ˆæ¸…ç§‹è·³å…¥æ± ä¸­ï¼Œè¯•å›¾å¸®ä»–åŒ–è§£è¯æ€§ã€‚ç„¶è€Œä¸€ç‚·é¦™è¿‡å»ï¼Œæ²ˆæ¸…ç§‹ä½“å†…çƒ­åº¦æœªé€€ï¼Œåå› å¤–ç•Œæå¯’åˆºæ¿€ï¼Œé€¼å¾—è¯æ€§ç–¯ç‹‚åæ‰‘ã€‚", mood: 'narrative', bg: ASSETS.bg.coldspring, sound: ASSETS.audio.splash },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆçŒ›åœ°å–·å‡ºä¸€å£é²œè¡€ï¼‰å™—â€”â€”", mood: 'pain' },
                    { speaker: 'æ—ç™½', text: "çœ¼è§’ã€é¼»ä¸‹ã€è€³å­”ï¼Œç«Ÿéƒ½æ¸—å‡ºäº†ç»†ç»†è¡€ä¸ã€‚ä¸ƒçªæµè¡€ã€‚è¿™æ˜¯å³å°†çˆ†ä½“è€Œäº¡çš„å¾å…†ã€‚", mood: 'narrative' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆæŠ±ç€ä»–çš„æ‰‹å‰§çƒˆé¢¤æŠ–ï¼‰ï¼ˆå†…å¿ƒï¼‰å†·æ³‰æ²¡ç”¨ã€‚è¯å¤ªçƒˆï¼Œå·²å…¥éª¨é«“ã€‚", mood: 'sorrow' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆå†…å¿ƒï¼‰è‹¥ä¸ç–è§£ï¼Œå°ä¹ä¼šæ²¡å‘½çš„ã€‚çœŸçš„ä¼šæ­»ã€‚", mood: 'sorrow' },
                    { speaker: 'æ—ç™½', text: "ä»–çŸ¥é“æ¥ä¸‹æ¥å”¯ä¸€çš„åŠæ³•æ˜¯ä»€ä¹ˆï¼Œä½†ä»–ä¹ŸçŸ¥é“ä¸€æ—¦è¿ˆå‡ºé‚£ä¸€æ­¥ï¼Œä»–å’Œæ²ˆæ¸…ç§‹ä¹‹é—´é‚£å±‚å‹‰å¼ºç»´æŒçš„çª—æˆ·çº¸å°†è¢«æ…ç ´ï¼Œè¿æ¥çš„æˆ–è®¸æ˜¯æ­¤ç”Ÿä¸ç»çš„æ¨æ„ã€‚", mood: 'narrative' },],
                next: 'choice1'
            },
            'choice1': {
                type: 'choice',
                bg: ASSETS.bg.coldspring,
                question: "å²³æ¸…æºçœ‹ç€ç—›è‹¦ä¸‡åˆ†çš„æ²ˆæ¸…ç§‹ï¼Œå¿…é¡»åšå‡ºå†³å®šã€‚",
                options: [
                    { id: 'A', text: "å³ä½¿ä»–ä¼šæ­»ï¼Œä¹Ÿä¸èƒ½è¶äººä¹‹å±", next: 'endingBE1' },
                    { id: 'B', text: "æ¨æˆ‘ä¹Ÿå¥½ï¼Œæ€æˆ‘ä¹Ÿç½¢ï¼Œåªè¦ä½ æ´»ç€", next: 'chapter3' }
                ]
            },
            'chapter3': {
                lines: [
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆçº¢ç€çœ¼ï¼Œå°†äººçŒ›åœ°æŠ±èµ·ï¼‰æ¨æˆ‘ä¹Ÿå¥½ï¼Œæ€æˆ‘ä¹Ÿç½¢â€¦â€¦åªè¦ä½ æ´»ç€ã€‚", mood: 'dark', bg: ASSETS.bg.bedroom },
                    { speaker: 'æ—ç™½', text: "æŒé—¨å¯æ®¿ï¼Œç»“ç•Œè½ä¸‹ã€‚è‚Œè‚¤ç›¸äº²ç¬é—´ï¼Œç”œè…»é¦™æ°”å½»åº•å¼•çˆ†ä¸€åˆ‡ã€‚æ²ˆæ¸…ç§‹æœ¬èƒ½åœ°å°†ä»–å½“æˆå”¯ä¸€æ•‘èµï¼Œæ­»æ­»ç¼ ä½å²³æ¸…æºè„–é¢ˆã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆéš¾å—åœ°è¹­ç€ï¼Œçœ¼æ³ªå¤§é¢—æ»šè½ï¼‰â€¦â€¦ä¸ƒå“¥â€¦â€¦æ•‘æˆ‘â€¦â€¦ä¸ƒå“¥â€¦â€¦å¥½éš¾å—â€¦â€¦", mood: 'shame' },
                    { speaker: 'æ—ç™½', text: "ä»–ä½ä¸‹å¤´ï¼Œè¿‘ä¹å‡¶ç‹ åœ°å»ä½é‚£å¼ å–Šç–¼çš„å˜´ï¼ŒåŠ¨ä½œä¸å†æ˜¯å•çº¯æ•‘æ²»ï¼Œè€Œæ˜¯æ··æ‚ç»æœ›çš„æ å¤ºã€‚", mood: 'narrative' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆçœ¼åº•å¢¨è‰²ç¿»æ¶Œï¼‰å°ä¹â€¦â€¦ä¸ƒå“¥æ•‘ä½ â€¦â€¦ä¸ƒå“¥è¿™å°±ç»™ä½ â€¦â€¦", mood: 'dark' },
                    { speaker: 'æ—ç™½', text: "è¡£è¡«å°½è£‚ï¼Œæ»¡å®¤è’å”ã€‚è¿™æ˜¯ä¸€åœºåä¸ºæ•‘èµçš„å‡Œè¿Ÿã€‚æ²ˆæ¸…ç§‹åœ¨è¯åŠ›é©±ä½¿ä¸‹å±•ç°å‡ºä»æœªè§è¿‡çš„åªšæ€ï¼Œå²³æ¸…æºåˆ™åœ¨æ²ˆæ¸…ç§‹ä¸€å£°å£°å˜è°ƒçš„â€œä¸ƒå“¥â€ä¸­ï¼Œå½»åº•ç–¯é­”ã€‚", mood: 'narrative', sound: ASSETS.audio.cloth, rhythm: true },
                    { speaker: 'æ—ç™½', text: "ä»–è¦ä¸å¤Ÿã€‚æƒ³å’Œä»–èä¸ºä¸€ä½“ï¼Œæƒ³è®©ä»–æ°¸è¿œåªèƒ½è¿™æ ·å“­ç€å–Šè‡ªå·±åå­—ï¼Œæƒ³æŠŠé”™è¿‡çš„æ—¶å…‰ï¼Œéƒ½åœ¨è¿™ä¸€å¤œç‹ ç‹ è¡¥å›æ¥ã€‚", mood: 'narrative', rhythm: true },
                    { speaker: 'æ—ç™½', text: "ç¿Œæ—¥æ¸…æ™¨ã€‚å¯æ®¿ä¸€ç‰‡ç‹¼è—‰ã€‚æ²ˆæ¸…ç§‹åœ¨ä¸€é˜µé…¸ç—›ä¸­é†’æ¥ï¼Œæ„Ÿè§‰åƒè¢«æ‹†æ•£æ¶å­åˆé‡æ–°æ‹¼å‡‘ï¼Œå°¤å…¶é‚£éš¾ä»¥å¯é½¿ä¹‹å¤„ï¼Œä¼ æ¥ç«è¾£è¾£çš„å¼‚æ ·ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "è®°å¿†å¦‚æ½®æ°´å›ç¬¼ã€‚æ˜¨æ™šçš„ç‡¥çƒ­ã€ç»æœ›ã€æ±‚æ•‘â€¦â€¦ä»¥åŠåæ¥é‚£åœºç–¯ç‹‚ç¼ ç»µã€‚ä»–è®°å¾—å²³æ¸…æºçš„æ±—æ°´æ»´åœ¨èƒ¸å£ï¼Œè®°å¾—å¯¹æ–¹åœ¨è€³è¾¹ä½å¼â€œå°ä¹â€ï¼Œæ›´è®°å¾—â€¦â€¦è‡ªå·±å¦‚ä½•åƒä¸ªä¸çŸ¥å»‰è€»çš„è¡å¦‡ï¼Œä¸»åŠ¨å“­æ±‚ã€çº ç¼ ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆçœ‹ç€èº«ä¾§ç†Ÿç¡çš„å²³æ¸…æºï¼Œè„¸è‰²æƒ¨ç™½ï¼‰ï¼ˆå†…å¿ƒï¼‰å¤ªå¯ç¬‘äº†ã€‚å¤ªä¸‹è´±äº†ã€‚", mood: 'despair' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰æ˜¨æ™šé‚£åœºè’å”ä¸­ï¼Œæˆ‘ç«Ÿæ„Ÿåˆ°ä¸€ä¸æ»¡è¶³ã€‚è¢«å²³æ¸…æºå®Œå…¨å æœ‰ä¸­ç«Ÿæ„Ÿåˆ°äº†ä¹…è¿çš„è¸å®ã€‚æˆ‘ç«Ÿç„¶â€¦â€¦è¿˜æ˜¯çˆ±ç€è¿™ä¸ªæ¨äº†åŠè¾ˆå­çš„äººã€‚", mood: 'despair' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹æ— æ³•é¢å¯¹è¿™æ ·çš„è‡ªå·±ï¼Œæ›´æ— æ³•é¢å¯¹é†’æ¥çš„å²³æ¸…æºã€‚ä»–ä¸çŸ¥è¯¥ç”¨ä»€ä¹ˆè¡¨æƒ…å¬è§£é‡Šï¼Œä¹Ÿä¸çŸ¥å¦‚ä½•å¤„ç†è¿™çªç„¶å˜è´¨çš„å…³ç³»ã€‚", mood: 'system' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆè„‘æµ·ä¸­å”¯ä¸€çš„å¿µå¤´ï¼‰é€ƒã€‚", mood: 'despair' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹å¼ºå¿ä¸é€‚ã€‚æ¡èµ·åœ°ä¸Šè¢«æ’•ç ´çš„é’è¡«èƒ¡ä¹±å¥—ä¸Šï¼Œåˆéšæ‰‹æŠ“äº†ä»¶å²³æ¸…æºå¤–è¢è£¹ä½è‡ªå·±ã€‚ä»–ä¸æ•¢å›å¤´ï¼Œè·Œè·Œæ’æ’å†²å‡ºå¯æ®¿ï¼Œé¿å¼€æ‰€æœ‰å·¡å®ˆå¼Ÿå­ï¼Œåƒä¸ªè§ä¸å¾—å…‰çš„å°å·ï¼Œç‹¼ç‹ˆé€ƒç¦»è‹ç©¹å±±ã€‚", mood: 'system' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆé†’æ¥é¢å¯¹ç©ºè¡çš„æ€€æŠ±ï¼Œå¿ƒå¤´ä¸€æ…Œï¼‰å°ä¹ï¼Ÿ", mood: 'worried' },
                    { speaker: 'æ—ç™½', text: "æ²¡æœ‰ã€‚å“ªé‡Œéƒ½æ²¡æœ‰ã€‚å²³æ¸…æºçœ‹ç€æ»¡åœ°ç‹¼è—‰â€”â€”ç¢è£‚çš„é’è¡«ã€æŸ“è¡€çš„é”¦è¢«ã€‚ä»–çŸ¥æ˜¨æ™šæ˜¯æƒ…æ€¥æ— å¥ˆï¼Œä½†ä¹Ÿåšå¥½äº†æ‰¿å—æ€’ç«çš„å‡†å¤‡ã€‚ä»–ä»¥ä¸ºå°ä¹é†’æ¥ä¼šæ¨ä»–å…¥éª¨ï¼Œç”šè‡³æ‹”å‰‘ç›¸å‘ã€‚ä»–æ„¿å—è¿™ä»½æ¨ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ä»–è¿˜ä»¥ä¸ºï¼Œåªè¦è´Ÿè´£ï¼ŒæåŠ›æŒ½ç•™ï¼Œä»–ä»¬ä¹‹é—´æˆ–è®¸â€¦â€¦å¯å°ä¹é€ƒäº†ã€‚å®æ„¿å¸¦ç€ä¸€èº«ä¼¤ç—›ä½™æ¯’ï¼Œä¹Ÿè¦é€ƒç¦»ä»–ã€‚", mood: 'narrative' },
                    { speaker: 'æœ¨æ¸…èŠ³', text: "æŒé—¨å¸ˆå…„ï¼Ÿä»Šæ—¥æ€ä¹ˆæœ‰ç©ºâ€¦â€¦", mood: 'neutral', bg: ASSETS.bg.qiancao },
                    { speaker: 'æœ¨æ¸…èŠ³', text: "ï¼ˆå†…å¿ƒï¼‰æŒé—¨å¸ˆå…„è„–é¢ˆé”éª¨å¤„çš„æ·±ç´«æŠ“ç—•å’Œå¸¦è¡€å’¬ç—•â€¦â€¦é‚£æ˜¯æåº¦æ¿€çƒˆçš„ç¼ ç»µæ‰€ç•™ã€‚æ•´ä¸ªè‹ç©¹å±±ï¼Œæ•¢åœ¨æŒé—¨èº«ä¸Šç•™ç—•çš„ï¼Œé™¤é‚£äººå¤–â€¦â€¦", mood: 'surprised' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆé¢è‰²é˜´é¸·ï¼‰æŸ¥ï¼è¿™åˆ°åº•æ˜¯ä»€ä¹ˆã€‚ï¼ˆæŠŠä¸¹è¯ç¢ç‰‡æ‰”åˆ°æ¡Œä¸Šï¼‰", mood: 'dark' },
                    { speaker: 'æœ¨æ¸…èŠ³', text: "ï¼ˆè„¸è‰²ç…ç™½ï¼‰æŒâ€¦â€¦æŒé—¨å¸ˆå…„ï¼Ÿè¿™â€¦â€¦ä¸»æ–™æ²¡é—®é¢˜ï¼Œä½†è¾…æ–™â€œé¾™æ¶è‰â€è¢«æ¢æˆäº†â€œåˆæ¬¢åƒå¶çº¢â€ï¼è¿™æ˜¯åˆæ¬¢å®—æµå‡ºçš„åŠ£è´¨å‚¬æƒ…è¾…æ–™â€¦â€¦", mood: 'worried' },
                    { speaker: 'æœ¨æ¸…èŠ³', text: "æ˜¯â€¦â€¦å®‰å®šå³°é‡‡è´­çš„ã€‚å°šå¸ˆå…„å‰äº›æ—¥å­è¯´ï¼Œæœ‰æ¸ é“ä½ä»·æ‹¿é«˜é˜¶çµè‰ï¼Œèƒ½ä¸ºé—¨æ´¾çœä¸€å¤§ç¬”å¼€æ”¯â€¦â€¦", mood: 'worried' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆæ°”æåç¬‘ï¼Œç¬‘å®¹æ¸—äººï¼‰çœé’±ï¼Ÿä¼ æˆ‘æŒé—¨ä»¤ã€‚å°šæ¸…åæ»¥ç”¨èŒæƒï¼Œé‡‡è´­åŠ£è¯ï¼Œè‡´åŒé—¨å—å®³ï¼Œé™©é…¿å¤§ç¥¸ã€‚", mood: 'dark' },
                    { speaker: 'å²³æ¸…æº', text: "å³æ—¥èµ·ï¼Œé©å»å°šæ¸…åå®‰å®šå³°å³°ä¸»åŠå¹´ä¿¸ç¦„ï¼Œç½šæ²¡ç§åº“å……å…¬ã€‚å‘½ä»–äº²è‡ªæ¸…ç†é‚£æ‰¹åŠ£è¯ï¼Œä¸€é¢—ä¸è®¸å‰©ã€‚", mood: 'determined' },
                    { speaker: 'å²³æ¸…æº', text: "è¿˜æœ‰ï¼Œç¦è¶³å®‰å®šå³°ä¸‰ä¸ªæœˆï¼Œè®©ä»–æŠŠä»¥å‰æ‰€æœ‰è´¦ç›®é‡ç®—ä¸€éã€‚è‹¥å†æœ‰çº°æ¼ï¼Œæˆ‘å°±è®©ä»–å»ç™¾æˆ˜å³°ç»™æŸ³å¸ˆå¼Ÿå½“é™ªç»ƒã€‚", mood: 'determined' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆæŠšæ‘¸ç€è„–é¢ˆä¸Šçš„å»ç—•ï¼‰å°ä¹â€¦â€¦å“ªæ€•ç¿»éä¹å·ï¼Œæˆ‘ä¹Ÿè¦æ‰¾åˆ°ä½ ã€‚", mood: 'dark' },
                ],
                next: 'chapter4'
            },
            'chapter4': {
                lines: [
                    { speaker: 'æ—ç™½', text: "ç¦»å¼€è‹ç©¹å±±åï¼Œæ²ˆæ¸…ç§‹åƒä¸€ç¼•ä¸çŸ¥å½’å¤„çš„æ¸¸é­‚ã€‚", mood: 'narrative', bg: ASSETS.bg.nuanhong },
                    { speaker: 'æ—ç™½', text: "åŒè„šä¼¼æœ‰è‡ªæˆ‘æ„è¯†ï¼Œå…œå…œè½¬è½¬ï¼Œç»ˆæ˜¯å›åˆ°äº†é‚£åº§è§è¯äº†ä»–æ‰€æœ‰å‘å¾®ä¸ç»æœ›çš„å°åŸã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å¤œè‰²å¦‚å¢¨ï¼Œå‹¾æ ç“¦èˆé—´ç¬™æ­Œæ›¼èˆã€‚ä»–è¸å…¥äº†ä¸€å®¶åä¸ºâ€œæš–çº¢é˜â€çš„é’æ¥¼ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆéšæ‰‹æ·ä¸‹ä¸€é”­é“¶å­ï¼Œé¢å®¹æ†”æ‚´å´éš¾æ©è´µæ°”ï¼‰è¦æœ€å¥½çš„åŒ…é—´ã€‚æ‰¾ä¸ªçµç¶æŠ€è‰ºæœ€ç²¾çš„å§‘å¨˜æ¥ã€‚", mood: 'disdain' },
                    { speaker: 'æ—ç™½', text: "åŒ…é—´å†…ï¼Œé¦™æ°”ç”œè…»ã€‚", mood: 'narrative' },
                    { speaker: 'çµç¶å¥³', text: "ï¼ˆè§ä»–è¡£ç€ä¸å‡¡ï¼Œä¾¿æƒ³ä¾åä¸Šæ¥ï¼‰å…¬å­â€¦â€¦å¥´å®¶è¿™å°±ä¸ºæ‚¨â€¦â€¦", mood: 'neutral' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†·å£°æ‰“æ–­ï¼Œä¾§èº«èººåœ¨è½¯æ¦»ä¸Šï¼ŒèƒŒå¯¹ç€å¥¹ï¼‰ç¦»æˆ‘è¿œç‚¹ã€‚å¼¹ä½ çš„æ›²å­ã€‚åˆ«è¯´è¯ï¼Œå°±è¿™æ ·ã€‚", mood: 'disdain' },
                    { speaker: 'æ—ç™½', text: "ã€éŸ³æ•ˆã€‘çµç¶å£°èµ·ï¼Œå¹½å’½å©‰è½¬ã€‚", mood: 'system', sound: ASSETS.audio.pipa },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆé—­ä¸Šçœ¼ï¼Œå‘¼å¸æ¸æ¸å¹³ç¼“ï¼‰ï¼ˆå†…å¿ƒï¼‰è¿™ç§è„‚ç²‰æ°”â€¦â€¦ç”šè‡³å¸¦ç€äº›è®¸è…æœ½çš„å‘³é“â€¦â€¦", mood: 'soft' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰çœŸå¥‡æ€ªã€‚åœ¨æ¸…é™å³°é—»æƒ¯äº†ç«¹é¦™å¢¨é¦™ï¼Œå¦‚ä»Šé—»åˆ°è¿™è‚¡å»‰ä»·çš„ä¿—å‘³ï¼Œåå€’è«åè§‰å¾—å¿ƒå®‰ã€‚", mood: 'soft' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰ä»¿ä½›æˆ‘ä»æœªä¸Šè¿‡è‹ç©¹å±±ï¼Œä»æœªåšè¿‡é«˜é«˜åœ¨ä¸Šçš„å³°ä¸»ã€‚æˆ‘ä¾ç„¶æ˜¯é‚£ä¸ªåœ¨æ³¥æ²¼é‡Œæ‰“æ»šï¼Œåªé…æ‹¥æœ‰è¿™ç§å»‰ä»·æ¸©æŸ”çš„æ²ˆä¹ã€‚", mood: 'soft' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå˜´è§’å‹¾èµ·ä¸€æŠ¹è‡ªå˜²çš„å¼§åº¦ï¼‰çœ‹å•Šï¼Œæ²ˆä¹ï¼Œè¿™æ‰æ˜¯ä½ çš„å½’å®¿ã€‚çƒ‚æ³¥ï¼Œå°±è¯¥å¾…åœ¨çƒ‚æ³¥é‡Œã€‚", mood: 'despair' },
                    { speaker: 'æ—ç™½', text: "ã€é—ªå›ç”»é¢ã€‘é‚£å¤œå²³æ¸…æºæ·±æƒ…çš„çœ¼ç¥ï¼Œè€³è¾¹çš„å–˜æ¯ã€‚", mood: 'memory', bg: ASSETS.bg.bedroom },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆæŒ‡èŠ‚çŒ›åœ°æŠ“ç´§èº«ä¸‹çš„é”¦è¤¥ï¼‰ï¼ˆå†…å¿ƒï¼‰é‚£å¤œçš„è’å”â€¦â€¦ä¸è¿‡æ˜¯è¯åŠ›ä½œç¥Ÿã€‚", mood: 'pain', bg: ASSETS.bg.nuanhong },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰æ˜¯é‚£ä¼ªå›å­ä¸å¾—ä¸æ–½èˆçš„æ…ˆæ‚²ï¼Œæ˜¯ä¸ºäº†æ•‘ä¸€æ¡ç‹—å‘½è€Œä¸å¾—å·²ä¸ºä¹‹ã€‚", mood: 'pain' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰å¯ç¬‘çš„æ˜¯â€¦â€¦ä½ ç«ŸçœŸçš„åœ¨é‚£ä¸€åˆ»åŠ¨äº†å¿ƒï¼Ÿç«ŸçœŸçš„åœ¨ä¸€å£°å£°â€œå°ä¹â€é‡Œç”Ÿå‡ºäº†æ»¡è¶³ï¼Ÿ", mood: 'pain' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå°†è„¸åŸ‹è¿›è‡‚å¼¯ï¼Œæµ‘èº«è½»é¢¤ï¼‰æ²ˆä¹â€¦â€¦ä½ å½“çœŸè´±å…¥éª¨é«“ã€‚è¿æœ€åä¸€ç‚¹å°Šä¸¥ï¼Œéƒ½è¦äº²æ‰‹ç¢¾ç¢ã€‚", mood: 'shame' },
                    { speaker: 'æ—ç™½', text: "è¿™ä¸€å¤œï¼Œä»–åœ¨çµç¶å£°ä¸­å½»å¤œæœªçœ ï¼Œä»»ç”±å¿ƒåº•çš„æ¯’è›‡å°†è‡ªå·±å•ƒå™¬å¾—é²œè¡€æ·‹æ¼“ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å¤©åˆšç ´æ™“ï¼Œä»–æ¨å¼€é‚£å§‘å¨˜ï¼Œæ‰”ä¸‹èµé’±ã€‚", mood: 'narrative' },
                ],
                next: 'chapter5'
            },
            'chapter5': {
                lines: [
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹æ»¡èº«è§ç´¢ï¼Œèµ°å‘åŸä¸œé‚£ç‰‡ç„¦é»‘çš„åºŸå¢Ÿã€‚é‚£æ˜¯ä¸€ç‰‡ç„¦åœŸåºŸå¢Ÿâ€”â€”æ›¾ç»çš„ç§‹åºœã€‚", mood: 'narrative', bg: ASSETS.bg.ruin },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹ä¼«ç«‹åœ¨æ–­å£æ®‹å£å‰ï¼Œä¿®é›…å‰‘æ‹„åœ°ï¼ŒæŒ‡èŠ‚æ³›ç™½ã€‚è®°å¿†ä¸­çš„çƒˆç«ä¼¼ä¹ä»åœ¨ç„šçƒ§ï¼Œç¼å¾—äº”è„å…­è…‘éƒ½åœ¨ç—›ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ä»–æ¨å²³æ¸…æºã€‚æ¨ä»–ä¸€å»ä¸å›ï¼Œæ¨ä»–ä¸ºäº†å‰ç¨‹æŠ›å¼ƒç›¸ä¾ä¸ºå‘½çš„å¼Ÿå¼Ÿã€‚å¯å¦‚ä»Šï¼Œé‚£ä¸ªæœ¬è¯¥æ¨é€äº†çš„äººï¼Œå´ç”¨ä¸€ç§è¿‘ä¹æ¯ç­çš„æ–¹å¼å æœ‰äº†ä»–ï¼Œæ•‘äº†ä»–ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå¯¹ç€åºŸå¢Ÿå˜¶å“‘ä½å¼ï¼‰ä¸ºä»€ä¹ˆâ€¦â€¦æ—¢å½“åˆå¼ƒæˆ‘ï¼Œå¦‚ä»Šåˆä½•å¿…å‡æƒºæƒºæ¥æ‹›æƒ¹ï¼", mood: 'despair' },
                    { speaker: 'æ—ç™½', text: "æ·±é™·è‡ªæˆ‘åŒæ¶ä¹‹é™…ï¼Œèº«åéª¤ç„¶å“èµ·æ€¥ä¿ƒæ²‰é‡çš„è„šæ­¥å£°ã€‚æ²ˆæ¸…ç§‹è„ŠèƒŒä¸€åƒµï¼ŒçŒ›åœ°å›é¦–ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "é‚£ä¸ªç†Ÿæ‚‰çš„èº«å½±ç«‹åœ¨æ™¨å…‰ä¸é˜´å½±äº¤ç•Œå¤„ã€‚ç„è¡£æŸ“å°˜ï¼Œå‘æ¥ä¸€ä¸ä¸è‹Ÿçš„å‘ä¸æ­¤åˆ»ç•¥æ˜¾å‡Œä¹±ã€‚ä»–ä¸€çœ¼ä¾¿ç§è§æ²ˆæ¸…ç§‹è¡£é¢†æ²¾æŸ“çš„è„‚ç²‰æ°”ï¼Œæ›´çœ‹ç©¿äº†é‚£åŒå‡¤çœ¸åº•ä¸‹çš„æ­»å¯‚ã€‚å²³æ¸…æºç—›å¦‚å‰œå¿ƒã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "åœ¨æ²ˆæ¸…ç§‹è½¬èº«æ¬²èµ°çš„ç¬é—´ï¼Œä»–èº«å½¢ä¸€é—ªï¼Œé“é’³èˆ¬çš„æ‰‹æŒå·²æ‰£ä½æ²ˆæ¸…ç§‹æ‰‹è…•ï¼Œä¸å®¹ç½®ç–‘åœ°å°†äººæ‹–è‡³åºŸå¢Ÿæ·±å¤„ï¼Œé‚£ç‰‡æ›¾ç»æ˜¯æŸ´æˆ¿çš„ç„¦åœŸä¹‹ä¸Šã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆçµåŠ›æ¿€è¡ï¼Œæ‹¼å‘½æŒ£æ‰ï¼‰å²³æ¸…æºï¼ä½ æ”¾æ‰‹ï¼", mood: 'despair' },
                    { speaker: 'å²³æ¸…æº', text: "æˆ‘ä¸æ”¾ã€‚ä½ è¿˜è¦èº²åˆ°å‡ æ—¶ï¼Ÿ", mood: 'sorrow' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆçœ¼å°¾æ³›çº¢ï¼Œå†·ç¬‘è®¥è®½ï¼‰å²³æŒé—¨è‹¥æ€•æˆ‘è´¥åè‹ç©¹å±±åå£°ï¼Œå¤§å¯æ¸…ç†é—¨æˆ·ï¼ä¼¼æˆ‘è¿™èˆ¬æµè¿çƒŸèŠ±æŸ³å··ä¹‹äººï¼Œæœ¬æ¥å°±è„â€¦â€¦", mood: 'disdain' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆä¸€å£°æš´å–ï¼‰ä½å£ï¼ä½ çŸ¥é“æˆ‘éä¸ºæ­¤äº‹ã€‚ä½ ä»¥ä¸ºé‚£æ™šæ˜¯æˆ‘æ•‘äº†ä½ ï¼Ÿå°ä¹ï¼Œé‚£æ˜¯ä½ åœ¨è‡ªæ•‘ï¼", mood: 'dark' },
                    { speaker: 'å²³æ¸…æº', text: "æ˜¯ä½ å¿ƒé‡Œç»ˆäºè‚¯è®©æˆ‘é è¿‘ï¼Œè‚¯å“­ç€å–Šæˆ‘ä¸€å£°ä¸ƒå“¥â€¦â€¦ä½ é€ƒæ ¹æœ¬ä¸æ˜¯å› ä¸ºæ¨æˆ‘ï¼Œä½ æ˜¯æ¨ä½ è‡ªå·±ï¼", mood: 'dark' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆèµ¤çº¢ç€çœ¼ä¹æ±‚ï¼‰ä½ è‹¥è¿˜æœ‰æ¨ï¼Œæ‹”å‡ºç„è‚ƒå–æˆ‘æ€§å‘½ï¼åªæ±‚ä½ ï¼Œåˆ«å†ä½œè·µä½ è‡ªå·±ï¼", mood: 'sorrow' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå½»åº•å´©æºƒï¼‰é—­å˜´â€¦â€¦ä½ é—­å˜´ï¼ï¼", mood: 'shame' },
                ],
                next: 'choice2'
            },
            'choice2': {
                type: 'choice',
                bg: ASSETS.bg.ruin,
                question: "æ²ˆæ¸…ç§‹çš„ä¿®é›…å‰‘å°–æŒ‡ç€å²³æ¸…æºã€‚",
                options: [
                    { id: 'A', text: "æ—¢ç„¶çŸ¥é“ï¼Œé‚£å°±å»æ­»ï¼", next: 'chapter6' },
                    { id: 'B', text: "åœæ‰‹ï¼Œè½¬èº«ç¦»å¼€", next: 'endingBE2' }
                ]
            },
            'chapter6': {
                lines: [
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆä¿®é›…å‰‘é“®ç„¶å‡ºé˜ï¼‰æ—¢ç„¶çŸ¥é“ï¼Œé‚£å°±å»æ­»ï¼ï¼", mood: 'shame', bg: ASSETS.bg.ruin },
                    { speaker: 'æ—ç™½', text: "å‰‘é”‹å³å°†è´¯ç©¿èƒ¸è†›çš„åˆ¹é‚£ï¼Œå²³æ¸…æºè…°é—´ç„è‚ƒå‰‘éª¤ç„¶å‘å‡ºä¸€å£°å‡„å‰æ‚²é¸£ï¼", mood: 'narrative', sound: ASSETS.audio.sword, shake: true },
                    { speaker: 'æ—ç™½', text: "é‚£éæŠ¤ä¸»å‰‘æ°”ï¼Œè€Œæ˜¯çµé­‚æ·±å¤„çš„å…±é¸£ä¸å“€åšã€‚æ²ˆæ¸…ç§‹çš„ç¥è¯†è¢«å¼ºè¡Œæ‹½å…¥ä¸€ç‰‡æ··æ²Œçš„è®°å¿†ä¹‹æµ·ã€‚", mood: 'narrative', sound: ASSETS.audio.magic, shake: true },
                    { speaker: 'æ—ç™½', text: "ã€è®°å¿†é—ªå›ã€‘å…¨èº«ç»è„‰å¯¸å¯¸æ–­è£‚ï¼Œé‚£æ˜¯è¢«æ©å¸ˆåºŸå»çµè„‰ï¼Œä»å¤´é‡å¡‘çš„é…·åˆ‘ã€‚ä»–è¶´åœ¨å†°å†·çŸ³åœ°ï¼Œæ‰‹æŒ‡æŠ å‡ºè¡€ç—•ï¼Œå£ä¸­å‘¢å–ƒï¼šâ€œæ”¾æˆ‘å‡ºå»â€¦â€¦æˆ‘å’Œå°ä¹çº¦å¥½äº†â€¦â€¦æˆ‘è¦å»æ•‘ä»–â€¦â€¦â€", mood: 'memory', bg: ASSETS.bg.lingxi },
                    { speaker: 'æ—ç™½', text: "ã€è®°å¿†é—ªå›ã€‘æ—¥å¤ä¸€æ—¥çš„ç…ç†¬ã€‚æ•´æ•´ä¸€å¹´ï¼Œæ¯ä¸€æ¯éƒ½åœ¨ç„šå¿ƒä¼¼ç«ä¸­åº¦è¿‡ã€‚", mood: 'memory' },
                    { speaker: 'æ—ç™½', text: "ã€è®°å¿†é—ªå›ã€‘â€œè‹¥æ— è·¯å¯èµ°ï¼Œä¾¿ä»¥å‘½å¼€è·¯ã€‚â€ å°‘å¹´å²³ä¸ƒä»¥å‘½å…¥å‰‘ï¼Œå£ä¸­æº¢è¡€ï¼Œå´åœ¨ç¬‘ï¼šâ€œå°ä¹â€¦â€¦ç­‰æˆ‘â€¦â€¦ä¸ƒå“¥æ¥äº†â€¦â€¦â€", mood: 'memory' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹çŒ›åœ°ä»è¡€è‰²è®°å¿†ä¸­æŒ£è„±ï¼Œä¿®é›…å‰‘å½“å•·è½åœ°ã€‚ä»–å†·æ±—æ¹¿é€ï¼ŒåŒè†ä¸€è½¯ï¼Œè·ªå€’åœ¨åºŸå¢Ÿå°˜åŸƒé‡Œã€‚", mood: 'narrative', bg: ASSETS.bg.ruin },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ç›´åˆ°è¿™ä¸€åˆ»ï¼Œæˆ‘æ‰ç»ˆäºå¬æ‡‚äº†è¿™å¥è¯â€¦â€¦â€œä½ è‹¥è¿˜æœ‰æ¨ï¼Œæ‹”å‡ºâ€˜ç„è‚ƒâ€™å–æˆ‘æ€§å‘½â€ã€‚", mood: 'shocked' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰é‚£ä¸æ˜¯ä¸€æŠŠå‰‘ï¼Œé‚£æ˜¯å²³æ¸…æºçš„å‘½ï¼åŸæ¥å¦‚æ­¤â€¦â€¦éæ˜¯ä¸ºäº†å‰ç¨‹ï¼Œéæ˜¯è´ªå›¾å¯Œè´µã€‚", mood: 'shocked' },
                    { speaker: 'æ—ç™½', text: "ä»–åœ¨ç§‹åºœå—è‹¦æ—¶ï¼Œå²³æ¸…æºåœ¨çµçŠ€æ´å—ç€åŒç­‰æƒ¨çƒˆçš„æŠ˜ç£¨ã€‚ä»–ä»¥ä¸ºçš„æŠ›å¼ƒï¼Œæ˜¯å²³æ¸…æºç”¨åŠæ¡å‘½æ¢æ¥ï¼Œå´ç»ˆç©¶è¿Ÿäº†ä¸€æ­¥çš„å¥”èµ´ã€‚æ‰€æœ‰çš„æ€¨æ¨ã€åˆ»è–„ã€è‡ªåŒï¼Œåœ¨è¿™ä»½æ²‰é‡çª’æ¯çš„çœŸç›¸é¢å‰ï¼Œæ˜¾å¾—å¦‚æ­¤å¯ç¬‘è‹ç™½ã€‚", mood: 'narrative' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆé¢è‰²æƒ¨ç™½ï¼Œå‚çœ¸ä¸æ•¢çœ‹æ²ˆæ¸…ç§‹ï¼Œæ­£æ¬²è½¬èº«ç¦»å»ï¼‰â€¦â€¦", mood: 'sorrow' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆè·Œæ’ä¸Šå‰ï¼Œæ­»æ­»æ‰£ä½ä»–çš„è…°èƒŒï¼Œæµ‘èº«æˆ˜æ —ï¼Œæ³ªæ°´æ±¹æ¶Œï¼‰ä¸ƒå“¥â€¦â€¦", mood: 'shocked' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆæµ‘èº«å·¨éœ‡ï¼Œç‹ ç‹ å°†æ€€ä¸­äººæ‰è¿›éª¨è¡€ï¼‰æˆ‘åœ¨ã€‚ï¼ˆæ³ªæ°´æ»‘è½ï¼‰å°ä¹ï¼Œæˆ‘ä»¬â€¦â€¦å›å®¶ã€‚å›è‹ç©¹å±±ã€‚", mood: 'gentle' },
                    { speaker: 'æ—ç™½', text: "å°˜åŸƒè½å®šã€‚å°šæ¸…åè¢«åºŸå»ä¿®ä¸ºæ‰“å…¥æ°´ç‰¢ã€‚è‹ç©¹å±±å¤œè‰²é‡å½’å®é™ã€‚æŒé—¨å¯æ®¿ï¼Œä»æ˜¯é‚£å¼ åºŠæ¦»ï¼Œæ°”æ°›å´æˆªç„¶ä¸åŒã€‚æ²ˆæ¸…ç§‹ä½“å†…ä½™æ¯’æ²‰ç§¯ï¼Œéœ€é åŒä¿®åŒ–è§£ã€‚", mood: 'narrative', bg: ASSETS.bg.bedroom },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆæ‰‹æŒ‡è½»æŠšä»–çš„çœ‰çœ¼ï¼Œåƒæ˜¯å¯¹å¾…ç¨€ä¸–çå®ï¼‰å°ä¹ï¼Œå¯èƒ½ä¼šæœ‰ç‚¹ç–¼ï¼Œå¿ä¸€å¿ã€‚", mood: 'gentle' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆç«æ¯›é¢¤äº†é¢¤ï¼Œè€³æ ¹å¾®çº¢ï¼‰å•°å—¦â€¦â€¦å¿«ç‚¹ã€‚", mood: 'soft' },
                    { speaker: 'æ—ç™½', text: "è¿™ä¸€æ¬¡ï¼Œæ²¡æœ‰ç–¯ç‹‚çš„æ’•å’¬ï¼Œæ²¡æœ‰ç»æœ›çš„å“­å–Šã€‚å”¯æœ‰æ¸©æŸ”çš„ç¼ ç»µã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºçš„åŠ¨ä½œå¾ˆæ…¢ï¼Œæ¯ä¸€ä¸ªå»éƒ½å……æ»¡äº†å®‰æŠšä¸çˆ±æ„ã€‚çµåŠ›éšç€èº«ä½“çš„ç»“åˆç¼“ç¼“æµå…¥æ²ˆæ¸…ç§‹çš„ä½“å†…ï¼Œæ¸©æš–è€ŒåŒ…å®¹ï¼Œä¸€ç‚¹ç‚¹æ´—åˆ·ç€ä»–ç»è„‰ä¸­çš„æ±¡æµŠä¸ç—›æ¥šã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹åœ¨æ™ƒåŠ¨çš„è§†çº¿ä¸­ï¼Œçœ‹ç€ä¸Šæ–¹é‚£ä¸ªæ»¡çœ¼éƒ½æ˜¯è‡ªå·±çš„ç”·äººã€‚ä»–æƒ³èµ·çµçŠ€æ´é‡Œé‚£ä¸ªæ»¡èº«é²œè¡€çš„å°‘å¹´ï¼Œæƒ³èµ·åºŸå¢Ÿå‰é‚£ä¸ªå¦ç„¶æ±‚æ­»çš„æŒé—¨ã€‚", mood: 'narrative', bg: ASSETS.bg.endingB },
                    { speaker: 'æ—ç™½', text: "ä»–å¿ƒä¸­çš„åšå†°å½»åº•åŒ–ä½œäº†ä¸€æ»©æ˜¥æ°´ã€‚æ²ˆæ¸…ç§‹ä»°èµ·å¤´ï¼Œç¬¨æ‹™è€Œåšå®šåœ°å»ä¸Šå²³æ¸…æºã€‚", mood: 'narrative', bg: ASSETS.bg.endingB },
                    { speaker: 'æ—ç™½', text: "é‚£åœºç”±åŠ£è´¨ä¸¹è¯å¼•å‘çš„çƒˆç«ï¼Œæ›¾å·®ç‚¹å°†ä»–ä»¬ç„šæ¯ã€‚å¯æœ€ç»ˆï¼Œè¿™æŠŠç«çƒ§å°½äº†æ‰€æœ‰çš„è™šä¼ªã€éš”é˜‚ä¸è¯¯è§£ï¼Œå°†ä¸¤é¢—æ—©å·²åƒç–®ç™¾å­”çš„å¿ƒï¼Œé‡æ–°ç†”é“¸åœ¨äº†ä¸€èµ·ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æƒ…ä¸çŸ¥æ‰€èµ·ï¼Œä¸€å¾€è€Œæ·±ã€‚æ¨ä¸çŸ¥æ‰€ç»ˆï¼Œä¸€ç¬‘è€Œæ³¯ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ã€Happy End: å½’é€”ã€‘", mood: 'success' },
                ],
                next: 'endingHE'
            },
            'endingHE': {
                type: 'ending',
                title: 'å½’é€”',
                text: "",
                bg: ASSETS.bg.endingB
            },
            'endingBE1': {
                type: 'ending',
                title: 'é˜´é˜³ä¸¤éš”',
                text: "å²³æ¸…æºæœ€ç»ˆæ²¡æœ‰è¶Šé›·æ± ä¸€æ­¥ã€‚é‚£ä¸€å¤œï¼Œæ²ˆæ¸…ç§‹çˆ†ä½“è€Œäº¡ï¼Œå²³æ¸…æºèµ°ç«å…¥é­”ï¼Œè‹ç©¹å±±æ´¾åŒå£çš†æŠ˜ã€‚",
                bg: ASSETS.bg.coldspring
            },
            'endingBE2': {
                type: 'ending',
                title: 'é™Œè·¯',
                text: "æ²ˆæ¸…ç§‹çœ‹ç€é€’è¿‡æ¥çš„ç„è‚ƒï¼Œå†·ç¬‘ä¸€å£°ï¼Œæ¨å¼€äº†å²³æ¸…æºçš„æ‰‹ã€‚ä»–è½¬èº«èµ°å‡ºåºŸå¢Ÿï¼Œä»æ­¤ä¿®çœŸç•Œå†æ— æ¸…é™å³°ä¸»ï¼Œåªæœ‰ä¸€ä¸ªæµæµªçš„æ•£ä¿®ã€‚å²³æ¸…æºå®ˆç€è‹ç©¹å±±ï¼Œå­¤ç‹¬ç»ˆè€ã€‚",
                bg: ASSETS.bg.ruin
            }
        };

        // --- ç»“å±€å…ƒæ•°æ® (ç”¨äºç»“å±€å›æ”¶) ---
        const ENDINGS_META = {
            'endingHE': {
                id: 'endingHE',
                title: 'å½’é€”',
                subtitle: 'Happy End',
                description: 'ç ´é•œé‡åœ†ï¼Œä¸¤äººç»ˆäºè§£å¼€å¿ƒç»“ï¼Œæºæ‰‹å…±åº¦ä½™ç”Ÿã€‚',
                color: 'text-amber-400'
            },
            'endingBE1': {
                id: 'endingBE1',
                title: 'é˜´é˜³ä¸¤éš”',
                subtitle: 'Bad End 1',
                description: 'å²³æ¸…æºçš„çŠ¹è±«ï¼Œæ¢æ¥çš„æ˜¯æ°¸æ’çš„åˆ†ç¦»ã€‚',
                color: 'text-red-400'
            },
            'endingBE2': {
                id: 'endingBE2',
                title: 'é™Œè·¯',
                subtitle: 'Bad End 2',
                description: 'æ²ˆæ¸…ç§‹é€‰æ‹©ç¦»å¼€ï¼Œä¸¤äººä»æ­¤å½¢åŒé™Œè·¯ã€‚',
                color: 'text-slate-400'
            }
        };
        const TOTAL_ENDINGS = Object.keys(ENDINGS_META).length;

        // --- ç« èŠ‚å…ƒæ•°æ® (ç”¨äºç« èŠ‚é€‰æ‹©) ---
        const CHAPTERS_META = {
            'chapter1': {
                id: 'chapter1',
                order: 1,
                title: 'ç¬¬ä¸€ç« ï¼šå‡è¯é£æ³¢',
                description: 'æ²ˆæ¸…ç§‹æ±‚è¯ä¸å¾—ï¼Œè¯¯æœè¢«æºå‡çš„ä¸¹è¯...'
            },
            'chapter2': {
                id: 'chapter2',
                order: 2,
                title: 'ç¬¬äºŒç« ï¼šç”Ÿæ­»æŠ‰æ‹©',
                description: 'å²³æ¸…æºé¢ä¸´è‰°éš¾çš„é€‰æ‹©...'
            },
            'chapter3': {
                id: 'chapter3',
                order: 3,
                title: 'ç¬¬ä¸‰ç« ï¼šè’å”ä¸€å¤œ',
                description: 'é‚£ä¸€å¤œçš„ç–¯ç‹‚ä¸æ•‘èµ...'
            },
            'chapter4': {
                id: 'chapter4',
                order: 4,
                title: 'ç¬¬å››ç« ï¼šæš–çº¢é˜å¿†',
                description: 'æ²ˆæ¸…ç§‹é€ƒç¦»è‹ç©¹å±±ï¼Œç‹¬è‡ªç–—ä¼¤...'
            },
            'chapter5': {
                id: 'chapter5',
                order: 5,
                title: 'ç¬¬äº”ç« ï¼šåºŸå¢Ÿé‡é€¢',
                description: 'åœ¨æ›¾ç»çš„ç§‹åºœåºŸå¢Ÿï¼Œä¸¤äººå†æ¬¡ç›¸è§...'
            },
            'chapter6': {
                id: 'chapter6',
                order: 6,
                title: 'ç¬¬å…­ç« ï¼šçœŸç›¸å¤§ç™½',
                description: 'ç„è‚ƒå‰‘çš„è®°å¿†æ­ç¤ºäº†ä¸€åˆ‡...'
            }
        };
        const TOTAL_CHAPTERS = Object.keys(CHAPTERS_META).length;

        // --- ç»„ä»¶ ---

        // 1. å›¾æ ‡åº“ (Lucide like)
        const Icon = ({ path, size = 24, className = "" }) => html`
            <svg xmlns="http://www.w3.org/2000/svg" width=${size} height=${size} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class=${className}>
                ${path}
            </svg>
        `;
        const Icons = {
            Menu: (p) => html`<${Icon} ...${p} path=${html`<line x1="3" y1="12" x2="21" y2="12" /><line x1="3" y1="6" x2="21" y2="6" /><line x1="3" y1="18" x2="21" y2="18" />`} />`,
            Volume2: (p) => html`<${Icon} ...${p} path=${html`<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07" />`} />`,
            VolumeX: (p) => html`<${Icon} ...${p} path=${html`<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><line x1="23" y1="9" x2="17" y2="15" /><line x1="17" y1="9" x2="23" y2="15" />`} />`,
            Save: (p) => html`<${Icon} ...${p} path=${html`<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" />`} />`,
            Upload: (p) => html`<${Icon} ...${p} path=${html`<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" />`} />`,
            RefreshCcw: (p) => html`<${Icon} ...${p} path=${html`<path d="M21 12A9 9 0 0 0 6.19 6.19l-.78-.78" /><path d="M3 12a9 9 0 0 0 14.81 5.81l.78.78" /><path d="M2 17H6v4" /><path d="M22 7H18V3" />`} />`,
            FileText: (p) => html`<${Icon} ...${p} path=${html`<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><line x1="10" y1="9" x2="8" y2="9" />`} />`,
            Play: (p) => html`<${Icon} ...${p} path=${html`<polygon points="5 3 19 12 5 21 5 3" />`} />`,
            Pause: (p) => html`<${Icon} ...${p} path=${html`<rect x="6" y="4" width="4" height="16" /><rect x="14" y="4" width="4" height="16" />`} />`,
            FastForward: (p) => html`<${Icon} ...${p} path=${html`<polygon points="13 19 22 12 13 5 13 19" /><polygon points="2 19 11 12 2 5 2 19" />`} />`,
            X: (p) => html`<${Icon} ...${p} path=${html`<line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" />`} />`,
            Trash: (p) => html`<${Icon} ...${p} path=${html`<polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />`} />`,
            ChevronLeft: (p) => html`<${Icon} ...${p} path=${html`<polyline points="15 18 9 12 15 6" />`} />`,
        };

        // 2. åŠ è½½é¡µé¢
        const Preloader = ({ onLoadComplete }) => {
            const [progress, setProgress] = useState(0);

            useEffect(() => {
                let loaded = 0;
                const total = Object.keys(ASSETS.bg).length + Object.keys(ASSETS.char).length;
                const images = [...Object.values(ASSETS.bg), ...Object.values(ASSETS.char)];

                if (images.length === 0) {
                    onLoadComplete();
                    return;
                }

                images.forEach(src => {
                    const img = new Image();
                    img.src = src;
                    img.onload = img.onerror = () => {
                        loaded++;
                        setProgress(Math.floor((loaded / total) * 100));
                        if (loaded === total) {
                            setTimeout(onLoadComplete, 500);
                        }
                    };
                });
            }, []);

            return html`
                <div class="fixed inset-0 z-50 bg-slate-950 flex flex-col items-center justify-center">
                    <div class="w-64 h-1 bg-slate-800 rounded-full overflow-hidden mb-4">
                        <div class="h-full bg-cyan-500 transition-all duration-300" style=${{ width: `${progress}%` }}></div>
                    </div>
                    <div class="text-slate-500 font-serif-sc tracking-widest text-sm animate-pulse">æ­£åœ¨è½½å…¥èµ„æº ${progress}%</div>
                </div>
            `;
        };

        // 3. å¯¹è¯æ¡†ç»„ä»¶
        const DialogueBox = ({ speaker, text, onNext, isTyping, typingText, isNarrative, onLog, onAuto, onSkip, isAuto, isSkip, onBack, canGoBack }) => {
            // é¢œè‰²æ˜ å°„
            const getColors = (name) => {
                if (name === 'æ²ˆæ¸…ç§‹') return { text: 'text-emerald-300', border: 'border-emerald-600/50' };
                if (name === 'å²³æ¸…æº') return { text: 'text-indigo-300', border: 'border-indigo-600/50' };
                if (name === 'æœ¨æ¸…èŠ³') return { text: 'text-amber-600', border: 'border-amber-700/50' };
                if (name === 'çµç¶å¥³') return { text: 'text-pink-300', border: 'border-pink-600/50' };
                if (name === 'ç³»ç»Ÿ') return { text: 'text-sky-300', border: 'border-sky-600/50' };
                if (name === 'æ—ç™½') return { text: 'text-amber-200/80', border: 'border-amber-600/30' };
                return { text: 'text-slate-300', border: 'border-cyan-600/50' };
            };

            const colors = getColors(speaker);

            return html`
                <div class="w-full max-w-4xl mx-auto mb-1 px-4 z-30 select-none pb-1" onClick=${onNext}>
                    <div class="relative">
                        ${!isNarrative && html`
                            <div class="absolute bottom-full left-0 mb-0 px-3 py-1 bg-slate-900/90 border border-b-0 ${colors.border} rounded-t text-xs md:text-sm lg:text-lg font-bold ${colors.text} shadow-lg backdrop-blur-sm">
                                ${speaker}
                            </div>
                        `}
                        <div class="dialogue-glass rounded-lg md:rounded-xl p-1.5 md:p-4 lg:p-8 h-20 md:h-32 lg:h-52 hover:bg-slate-900/40 transition-colors cursor-pointer border ${colors.border} overflow-hidden flex flex-col relative group/box">
                            <div class="flex-1 overflow-y-auto scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent pr-1">
                                <p class="font-serif-sc text-xs md:text-lg lg:text-2xl leading-relaxed whitespace-pre-wrap ${isNarrative ? 'italic text-slate-300' : 'text-slate-100 font-bold'}">
                                    ${typingText}
                                    ${isTyping && html`<span class="inline-block w-1.5 h-4 md:w-2 md:h-5 bg-cyan-400 align-middle ml-1 animate-pulse"></span>`}
                                </p>
                            </div>
                            
                            <!-- æŒ‰é’®ç»„ (æ•´åˆè¿›å¯¹è¯æ¡†å³ä¸‹è§’) -->
                            <div class="absolute bottom-1 right-1 md:bottom-2 md:right-2 flex gap-1 md:gap-2 z-50 opacity-100 md:opacity-0 md:group-hover/box:opacity-100 transition-opacity duration-300" onClick=${e => e.stopPropagation()}>
                                 <button onClick=${onBack} class="p-1 md:p-1.5 ${canGoBack ? 'bg-slate-800/80 text-cyan-200/80 hover:bg-cyan-900/80 hover:text-cyan-100' : 'bg-slate-800/40 text-slate-600 cursor-not-allowed'} rounded transition-colors" title="ä¸Šä¸€å¥" disabled=${!canGoBack}>
                                    <${Icons.ChevronLeft} size=${14} class="md:w-5 md:h-5" />
                                </button>
                                 <button onClick=${onLog} class="p-1 md:p-1.5 bg-slate-800/80 hover:bg-cyan-900/80 rounded text-cyan-200/80 hover:text-cyan-100 transition-colors" title="å›æ”¾">
                                    <${Icons.FileText} size=${14} class="md:w-5 md:h-5" />
                                </button>
                                <button onClick=${onAuto} class="p-1 md:p-1.5 ${isAuto ? 'bg-cyan-600 text-white' : 'bg-slate-800/80 text-cyan-200/80'} hover:bg-cyan-700 rounded transition-colors" title="è‡ªåŠ¨">
                                    <${isAuto ? Icons.Pause : Icons.Play} size=${14} class="md:w-5 md:h-5" />
                                </button>
                                <button onClick=${onSkip} class="p-1 md:p-1.5 ${isSkip ? 'bg-amber-600 text-white' : 'bg-slate-800/80 text-cyan-200/80'} hover:bg-amber-700 rounded transition-colors" title="å¿«è¿›">
                                    <${Icons.FastForward} size=${14} class="md:w-5 md:h-5" />
                                </button>
                            </div>

                            ${!isTyping && !isAuto && !isSkip && html`
                                <div class="absolute bottom-1 right-1 md:bottom-4 md:right-4 animate-bounce text-cyan-500/50 pointer-events-none">
                                    <svg width="12" height="12" class="md:w-4 md:h-4 lg:w-6 lg:h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 16l-6-6h12z"/></svg>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        };

        // 4. å¼€å§‹ç”»é¢
        const StartScreen = ({ onStart, onLoad, hasAutoSave, onEndings, onChapters, unlockedEndingsCount, unlockedChaptersCount, totalChapters }) => html`
            <div class="absolute inset-0 z-40 bg-black flex flex-col items-center justify-center overflow-hidden">
                <div class="absolute inset-0 animate-in zoom-in duration-[10s]">
                    <img src=${ASSETS.bg.start} class="w-full h-full object-cover opacity-60" />
                </div>
                <div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-slate-950/20 to-transparent"></div>
                
                <div class="relative z-50 text-center p-2 md:p-4 flex flex-col items-center gap-1 mobile-landscape-gap md:gap-4 lg:gap-8 animate-in fade-in slide-in-from-bottom-10 duration-1000">
                    <h1 class="font-calligraphy text-2xl mobile-landscape-title sm:text-3xl md:text-7xl text-slate-100 drop-shadow-[0_0_15px_rgba(255,255,255,0.3)] tracking-widest leading-relaxed">
                        å®‰å®šå³°é‡‡è´­å‡è¯<br/>å¼•å‘çš„æƒ¨æ¡ˆ
                    </h1>
                    
                    <div class="flex flex-col gap-2 mt-2 mobile-landscape-gap md:mt-4 lg:mt-8 w-full max-w-xs scale-90 md:scale-100">
                        <button onClick=${() => onStart()} class="px-4 py-1.5 mobile-landscape-btn md:px-8 md:py-3 bg-slate-800/50 hover:bg-slate-700/60 border border-slate-500/40 text-slate-100 text-lg md:text-2xl font-calligraphy rounded transition-all tracking-[0.2em] backdrop-blur-sm">
                            å¼€å§‹æ–°æ¸¸æˆ
                        </button>
                        
                        <div class="flex gap-2 w-full">
                            ${hasAutoSave && html`
                            <button onClick=${() => onLoad('auto')} class="flex-1 px-2 py-1.5 mobile-landscape-btn md:px-4 md:py-3 bg-slate-800/50 hover:bg-slate-700/60 border border-slate-500/40 text-slate-100 text-sm md:text-lg font-calligraphy rounded transition-all tracking-[0.1em] backdrop-blur-sm">
                                ç»§ç»­æ¸¸æˆ
                            </button>
                            `}
                            <button onClick=${() => onLoad('manual')} class="flex-1 px-2 py-1.5 mobile-landscape-btn md:px-4 md:py-3 bg-slate-800/50 hover:bg-slate-700/60 border border-slate-500/40 text-slate-100 text-sm md:text-lg font-calligraphy rounded transition-all tracking-[0.1em] backdrop-blur-sm">
                                è¯»å–å­˜æ¡£
                            </button>
                        </div>
                        
                        <!-- æ–°å¢ï¼šç»“å±€å›æ”¶å’Œç« èŠ‚é€‰æ‹© -->
                        <div class="flex gap-2 w-full mt-1">
                            <button onClick=${onChapters} class="flex-1 px-2 py-1.5 mobile-landscape-btn md:px-4 md:py-3 bg-slate-800/50 hover:bg-slate-700/60 border border-slate-500/40 text-slate-100 text-xs md:text-base font-calligraphy rounded transition-all tracking-[0.1em] backdrop-blur-sm">
                                ç« èŠ‚é€‰æ‹© <span class="text-cyan-400">${unlockedChaptersCount}/${totalChapters}</span>
                            </button>
                            <button onClick=${onEndings} class="flex-1 px-2 py-1.5 mobile-landscape-btn md:px-4 md:py-3 bg-slate-800/50 hover:bg-slate-700/60 border border-slate-500/40 text-slate-100 text-xs md:text-base font-calligraphy rounded transition-all tracking-[0.1em] backdrop-blur-sm">
                                ç»“å±€å›æ”¶ <span class="text-amber-400">${unlockedEndingsCount}/${TOTAL_ENDINGS}</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // 5. é€‰é¡¹ç»„ä»¶
        const ChoiceScreen = ({ question, options, onChoice }) => html`
            <div class="absolute inset-0 z-40 bg-slate-950/80 backdrop-blur flex items-center justify-center p-2 md:p-4">
                <div class="max-w-4xl w-full md:w-fit bg-slate-900 border-2 border-red-900/50 p-2 md:p-4 lg:p-10 rounded-lg shadow-2xl animate-in zoom-in duration-300 flex flex-col justify-center max-h-full overflow-hidden">
                    <div class="text-red-500 font-bold mb-1 md:mb-2 lg:mb-6 text-center tracking-widest uppercase text-[10px] md:text-xl lg:text-2xl border-b border-red-900/30 pb-1 shrink-0">å‘½è¿æŠ‰æ‹©</div>
                    <h2 class="text-xs md:text-base lg:text-2xl text-slate-200 font-serif-sc text-center mb-1 md:mb-2 lg:mb-10 leading-relaxed shrink-0">${question}</h2>
                    
                    <div class="grid grid-cols-2 gap-2 md:flex md:flex-col md:w-fit md:mx-auto md:gap-4 w-full overflow-y-auto custom-scroll pr-1">
                        ${options.map(opt => html`
                            <button onClick=${() => onChoice(opt)} class="group w-full text-left p-2 md:p-3 lg:p-5 border border-slate-700 hover:border-cyan-500 bg-slate-800/50 hover:bg-slate-700 transition-all rounded relative overflow-hidden flex flex-col justify-center min-h-[40px] md:min-h-[60px] lg:min-h-0">
                                <span class="relative z-10 text-[10px] md:text-sm lg:text-xl font-serif-sc leading-tight mb-0.5 md:mb-1 text-slate-200 group-hover:text-amber-100 transition-colors">${opt.text}</span>
                                ${opt.subtext && html`<div class="relative z-10 text-[8px] md:text-[10px] lg:text-xs text-slate-500 font-mono group-hover:text-cyan-400 leading-none">${opt.subtext}</div>`}
                                <div class="absolute inset-0 bg-cyan-900/10 translate-x-[-100%] group-hover:translate-x-0 transition-transform duration-500"></div>
                            </button>
                        `)}
                    </div>
                </div>
            </div>
        `;

        // 9. å­˜æ¡£/è¯»æ¡£ç•Œé¢ (Mobile Friendly Grid)
        const SaveLoadScreen = ({ mode, onClose, onSave, onLoad, saves, onDelete }) => {
            const isSave = mode === 'save';
            return html`
                <div class="absolute inset-0 z-[60] bg-slate-950/95 backdrop-blur flex flex-col p-4 md:p-8 animate-in fade-in duration-300" onClick=${e => e.stopPropagation()}>
                    <div class="flex justify-between items-center mb-6 shrink-0 border-b border-slate-800 pb-4">
                        <h2 class="text-2xl md:text-4xl text-slate-100 font-serif-sc font-bold tracking-widest flex items-center gap-4">
                            ${isSave ? 'æ¡£æ¡ˆè®°å½•' : 'æ¡£æ¡ˆè¯»å–'}
                            <span class="text-sm md:text-lg text-slate-500 font-sans font-normal tracking-normal self-end mb-1">Select a Slot</span>
                        </h2>
                        <button onClick=${onClose} class="p-2 hover:bg-slate-800 rounded-full transition-colors text-slate-400 hover:text-white">
                            <${Icons.X} size=${28} />
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto custom-scroll pr-2">
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6 pb-20 mobile-landscape-grid-2">
                             ${Array.from({ length: 12 }).map((_, i) => {
                const id = i + 1;
                const save = saves[id];
                return html`
                                    <div class="group relative aspect-[16/10] bg-slate-900 border-2 ${save ? 'border-slate-700 hover:border-cyan-500' : 'border-slate-800 hover:border-slate-600'} rounded-lg transition-all overflow-hidden flex flex-col cursor-pointer hover:shadow-[0_0_20px_rgba(0,0,0,0.5)] transform hover:-translate-y-1"
                                         onClick=${() => isSave ? onSave(id) : (save && onLoad(id))}
                                    >
                                        <!-- Header: ID and Date -->
                                        <div class="absolute top-0 left-0 right-0 p-2 bg-gradient-to-b from-black/80 to-transparent z-10 flex justify-between items-start text-[10px] md:text-xs">
                                            <span class="font-bold text-slate-400 font-mono">NO.${id.toString().padStart(2, '0')}</span>
                                            ${save && html`<span class="text-slate-300 bg-slate-900/50 px-1 rounded backdrop-blur-sm">${new Date(save.timestamp).toLocaleDateString()} ${new Date(save.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>`}
                                        </div>

                                        <!-- Preview Image -->
                                        <div class="absolute inset-0 bg-slate-800 flex items-center justify-center overflow-hidden">
                                            ${save ? html`
                                                <img src=${save.bg} class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" />
                                            ` : html`
                                                <div class="text-slate-700 font-serif-sc text-sm">ç©ºå­˜æ¡£</div>
                                            `}
                                        </div>

                                        <!-- Preview Text (Bottom Overlay) -->
                                        ${save && html`
                                            <div class="absolute bottom-0 left-0 right-0 p-2 md:p-3 bg-gradient-to-t from-black/95 via-black/70 to-transparent z-10">
                                                <div class="text-[10px] md:text-xs text-cyan-300 font-bold mb-0.5 truncate">${save.speaker || '???'}</div>
                                                <div class="text-[11px] md:text-sm text-slate-300 font-serif-sc line-clamp-2 h-8 md:h-10 leading-tight opacity-90">${save.previewText}</div>
                                            </div>
                                        `}

                                        <!-- Action Overlay (Delete) -->
                                        ${save && html`
                                            <div class="absolute top-2 right-2 z-20 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button onClick=${(e) => { e.stopPropagation(); onDelete(id); }} class="p-1.5 bg-red-900/80 hover:bg-red-700 text-red-200 rounded-full backdrop-blur shadow-lg transition-colors" title="åˆ é™¤å­˜æ¡£">
                                                    <${Icons.Trash} size=${14} />
                                                </button>
                                            </div>
                                        `}
                                        
                                        <!-- Hover Effect for Empty Save Slot -->
                                        ${!save && html`
                                            <div class="absolute inset-0 flex items-center justify-center bg-cyan-900/10 border-2 border-dashed border-cyan-800/50 rounded-lg hover:bg-cyan-900/20 transition-all">
                                                <span class="text-cyan-400/80 font-bold border border-cyan-500/50 px-3 py-1 rounded-full bg-slate-900/80 backdrop-blur shadow-lg">
                                                    ${mode === 'save' ? 'ç‚¹å‡»æ–°å»ºå­˜æ¡£' : 'ç©ºå­˜æ¡£'}
                                                </span>
                                            </div>
                                        `}
                                    </div>
                                `;
            })}
                        </div>
                    </div>
                </div>
            `;
        };

        // 6. èœå•ç»„ä»¶ (Modified for new Save/Load)
        const Menu = ({ onClose, onOpenSave, onOpenLoad, onOpenSettings, onBackTitle }) => html`
            <div class="absolute inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick=${onClose}>
                <div class="bg-slate-900 border border-slate-700 p-4 md:p-8 rounded-xl shadow-2xl w-[260px] md:w-[320px] flex flex-col gap-2 md:gap-4 max-h-full overflow-y-auto custom-scroll" onClick=${e => e.stopPropagation()}>
                    <h3 class="text-cyan-400 text-lg md:text-xl font-bold mb-1 md:mb-2 text-center shrink-0">ç³»ç»Ÿèœå•</h3>
                    
                    <button onClick=${onOpenSave} class="w-full p-3 md:p-4 bg-slate-800 hover:bg-cyan-900/30 text-slate-200 text-sm md:text-base rounded transition-colors border border-transparent hover:border-cyan-800 tracking-normal font-sans text-center font-bold shrink-0">
                        ä¿å­˜è®°å½•
                    </button>

                     <button onClick=${onOpenLoad} class="w-full p-3 md:p-4 bg-slate-800 hover:bg-indigo-900/30 text-slate-200 text-sm md:text-base rounded transition-colors border border-transparent hover:border-indigo-800 tracking-normal font-sans text-center font-bold shrink-0">
                        è¯»å–è®°å½•
                    </button>

                    <button onClick=${onOpenSettings} class="w-full p-3 md:p-4 bg-slate-800 hover:bg-emerald-900/30 text-slate-200 text-sm md:text-base rounded transition-colors border border-transparent hover:border-emerald-800 tracking-normal font-sans text-center font-bold shrink-0">
                        è®¾ç½®
                    </button>

                    <div class="h-px bg-slate-800 my-0 md:my-1 shrink-0"></div>
                    
                    <button onClick=${onBackTitle} class="w-full p-3 md:p-4 bg-red-900/20 hover:bg-red-900/40 text-red-300 text-sm md:text-base rounded transition-colors tracking-normal font-sans text-center font-bold shrink-0">
                        è¿”å›æ ‡é¢˜
                    </button>
                    
                    <button onClick=${onClose} class="mt-2 text-slate-500 hover:text-slate-300 text-sm text-center">
                        å…³é—­èœå•
                    </button>
                </div>
            </div>
        `;

        // è®¾ç½®ç•Œé¢
        const SettingsScreen = ({ textSpeed, onTextSpeedChange, onClose }) => {
            // Speed ranges: 10 (fast) - 80 (slow). Default is 30.
            const speedLabels = [
                { value: 10, label: 'æå¿«' },
                { value: 20, label: 'å¿«' },
                { value: 30, label: 'æ­£å¸¸' },
                { value: 50, label: 'æ…¢' },
                { value: 80, label: 'ææ…¢' },
            ];
            const currentLabel = speedLabels.reduce((prev, curr) =>
                Math.abs(curr.value - textSpeed) < Math.abs(prev.value - textSpeed) ? curr : prev
            ).label;

            return html`
                <div class="absolute inset-0 z-[60] bg-slate-950/95 backdrop-blur flex flex-col items-center justify-center p-4 md:p-8 animate-in fade-in duration-300" onClick=${e => e.stopPropagation()}>
                    <div class="bg-slate-900 border border-slate-700 p-6 md:p-10 rounded-xl shadow-2xl w-full max-w-md flex flex-col gap-6">
                        <div class="flex justify-between items-center border-b border-slate-700 pb-4">
                            <h2 class="text-2xl md:text-3xl text-slate-100 font-serif-sc font-bold">è®¾ç½®</h2>
                            <button onClick=${onClose} class="p-2 hover:bg-slate-800 rounded-full transition-colors text-slate-400 hover:text-white">
                                <${Icons.X} size=${24} />
                            </button>
                        </div>

                        <div class="flex flex-col gap-4">
                            <div class="flex flex-col gap-2">
                                <label class="text-slate-300 font-bold flex justify-between items-center">
                                    <span>æ–‡å­—é€Ÿåº¦</span>
                                    <span class="text-cyan-400 text-sm font-normal bg-slate-800 px-2 py-0.5 rounded">${currentLabel}</span>
                                </label>
                                <input 
                                    type="range" 
                                    min="10" 
                                    max="80" 
                                    step="5"
                                    value=${textSpeed}
                                    onInput=${(e) => onTextSpeedChange(parseInt(e.target.value))}
                                    class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500"
                                />
                                <div class="flex justify-between text-xs text-slate-500">
                                    <span>å¿«</span>
                                    <span>æ…¢</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // ç»“å±€å›æ”¶ç•Œé¢
        const EndingsScreen = ({ unlockedEndings, onClose, onSelectEnding }) => {
            const unlockedCount = unlockedEndings.size;

            return html`
                <div class="absolute inset-0 z-[60] bg-slate-950/95 backdrop-blur flex flex-col p-4 md:p-8 animate-in fade-in duration-300" onClick=${e => e.stopPropagation()}>
                    <div class="flex justify-between items-center mb-6 shrink-0 border-b border-slate-800 pb-4">
                        <h2 class="text-2xl md:text-4xl text-slate-100 font-serif-sc font-bold tracking-widest flex items-center gap-4">
                            ç»“å±€å›æ”¶
                            <span class="text-sm md:text-lg text-cyan-400 font-sans font-normal tracking-normal self-end mb-1 bg-slate-800 px-2 py-0.5 rounded">${unlockedCount} / ${TOTAL_ENDINGS}</span>
                        </h2>
                        <button onClick=${onClose} class="p-2 hover:bg-slate-800 rounded-full transition-colors text-slate-400 hover:text-white">
                            <${Icons.X} size=${28} />
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto custom-scroll pr-2">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 pb-10">
                            ${Object.values(ENDINGS_META).map(ending => {
                const isUnlocked = unlockedEndings.has(ending.id);
                return html`
                                    <div class="group relative bg-slate-900 border-2 ${isUnlocked ? 'border-slate-700 hover:border-amber-500 cursor-pointer' : 'border-slate-800 cursor-not-allowed'} rounded-lg p-4 md:p-6 transition-all ${isUnlocked ? 'hover:shadow-[0_0_20px_rgba(0,0,0,0.5)] transform hover:-translate-y-1' : 'opacity-50'}"
                                         onClick=${() => isUnlocked && onSelectEnding(ending.id)}>
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-xs md:text-sm ${isUnlocked ? ending.color : 'text-slate-600'} font-bold uppercase tracking-wider">${isUnlocked ? ending.subtitle : '???'}</span>
                                            ${isUnlocked ? html`
                                                <span class="text-xs text-green-400 bg-green-900/30 px-2 py-0.5 rounded-full">ç‚¹å‡»æŸ¥çœ‹</span>
                                            ` : html`
                                                <span class="text-xs text-slate-600 bg-slate-800 px-2 py-0.5 rounded-full">æœªè§£é”</span>
                                            `}
                                        </div>
                                        <h3 class="text-lg md:text-2xl font-serif-sc font-bold ${isUnlocked ? 'text-slate-100 group-hover:text-amber-200' : 'text-slate-600'} mb-2 transition-colors">
                                            ${isUnlocked ? ending.title : '???'}
                                        </h3>
                                        <p class="text-sm md:text-base ${isUnlocked ? 'text-slate-400' : 'text-slate-700'} font-serif-sc leading-relaxed">
                                            ${isUnlocked ? ending.description : 'è¾¾æˆæ­¤ç»“å±€åè§£é”'}
                                        </p>
                                        ${isUnlocked && html`
                                            <div class="absolute bottom-4 right-4 text-amber-400 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="9 18 15 12 9 6" />
                                                </svg>
                                            </div>
                                        `}
                                    </div>
                                `;
            })}
                        </div>
                    </div>
                </div>
            `;
        };

        // ç« èŠ‚é€‰æ‹©ç•Œé¢
        const ChaptersScreen = ({ unlockedChapters, onClose, onSelectChapter }) => {
            const unlockedCount = unlockedChapters.size;
            const sortedChapters = Object.values(CHAPTERS_META).sort((a, b) => a.order - b.order);

            return html`
                <div class="absolute inset-0 z-[60] bg-slate-950/95 backdrop-blur flex flex-col p-4 md:p-8 animate-in fade-in duration-300" onClick=${e => e.stopPropagation()}>
                    <div class="flex justify-between items-center mb-6 shrink-0 border-b border-slate-800 pb-4">
                        <h2 class="text-2xl md:text-4xl text-slate-100 font-serif-sc font-bold tracking-widest flex items-center gap-4">
                            ç« èŠ‚é€‰æ‹©
                            <span class="text-sm md:text-lg text-indigo-400 font-sans font-normal tracking-normal self-end mb-1 bg-slate-800 px-2 py-0.5 rounded">${unlockedCount} / ${TOTAL_CHAPTERS}</span>
                        </h2>
                        <button onClick=${onClose} class="p-2 hover:bg-slate-800 rounded-full transition-colors text-slate-400 hover:text-white">
                            <${Icons.X} size=${28} />
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto custom-scroll pr-2">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 pb-10">
                            ${sortedChapters.map(chapter => {
                const isUnlocked = unlockedChapters.has(chapter.id);
                return html`
                                    <div class="group relative bg-slate-900 border-2 ${isUnlocked ? 'border-slate-700 hover:border-indigo-500 cursor-pointer' : 'border-slate-800 cursor-not-allowed'} rounded-lg p-4 md:p-6 transition-all ${isUnlocked ? 'hover:shadow-[0_0_20px_rgba(0,0,0,0.5)] transform hover:-translate-y-1' : 'opacity-50'}"
                                         onClick=${() => isUnlocked && onSelectChapter(chapter.id)}>
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-xs md:text-sm text-indigo-400 font-bold uppercase tracking-wider">Chapter ${chapter.order}</span>
                                            ${isUnlocked ? html`
                                                <span class="text-xs text-green-400 bg-green-900/30 px-2 py-0.5 rounded-full">å·²è§£é”</span>
                                            ` : html`
                                                <span class="text-xs text-slate-600 bg-slate-800 px-2 py-0.5 rounded-full">æœªè§£é”</span>
                                            `}
                                        </div>
                                        <h3 class="text-lg md:text-2xl font-serif-sc font-bold ${isUnlocked ? 'text-slate-100 group-hover:text-indigo-200' : 'text-slate-600'} mb-2 transition-colors">
                                            ${isUnlocked ? chapter.title : '???'}
                                        </h3>
                                        <p class="text-sm md:text-base ${isUnlocked ? 'text-slate-400' : 'text-slate-700'} font-serif-sc leading-relaxed">
                                            ${isUnlocked ? chapter.description : 'é˜…è¯»æ­¤ç« èŠ‚åè§£é”'}
                                        </p>
                                        ${isUnlocked && html`
                                            <div class="absolute bottom-4 right-4 text-indigo-400 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="9 18 15 12 9 6" />
                                                </svg>
                                            </div>
                                        `}
                                    </div>
                                `;
            })}
                        </div>
                    </div>
                </div>
            `;
        };

        // 7. å†å²è®°å½•æ¨¡æ€æ¡†
        const HistoryModal = ({ history, onClose }) => {
            const endRef = useRef(null);

            useEffect(() => {
                if (endRef.current) {
                    endRef.current.scrollIntoView({ behavior: 'smooth' });
                }
            }, []);

            // é¢œè‰²æ˜ å°„ï¼ˆä¸å¯¹è¯æ¡†ä¿æŒä¸€è‡´ï¼‰
            const getSpeakerColor = (name) => {
                if (name === 'æ²ˆæ¸…ç§‹') return 'text-emerald-300';
                if (name === 'å²³æ¸…æº') return 'text-indigo-300';
                if (name === 'æœ¨æ¸…èŠ³') return 'text-amber-600';
                if (name === 'ç³»ç»Ÿ') return 'text-sky-300';
                if (name === 'æ—ç™½') return 'text-amber-200/80';
                if (name === 'çµç¶å¥³') return 'text-pink-300';
                return 'text-slate-300';
            };

            return html`
            <div class="absolute inset-0 z-[100] bg-black/90 backdrop-blur flex flex-col p-4 md:p-10 animate-in fade-in duration-300">
                <div class="flex justify-between items-center mb-4 md:mb-6 border-b border-slate-700 pb-2 md:pb-4 shrink-0">
                    <h2 class="text-xl md:text-3xl text-slate-100 font-serif-sc font-bold">å‰§æƒ…å›æ”¾</h2>
                    <button onClick=${onClose} class="p-2 hover:bg-slate-800 rounded-full transition-colors text-slate-400 hover:text-white">
                        <${Icons.X} size=${24} class="md:w-8 md:h-8" />
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto custom-scroll pr-2 md:pr-4 space-y-4 md:space-y-6">
                    ${history.length === 0 ? html`<div class="text-slate-500 text-center mt-20 italic font-serif-sc">æš‚æ— è®°å½•</div>` : null}
                    ${history.map((item, index) => html`
                        <div class="flex flex-col gap-1 items-start group">
                            <span class="text-xs md:text-sm font-bold ${getSpeakerColor(item.speaker)} px-2 py-0.5 rounded bg-slate-800/50 border border-slate-700/50">
                                ${item.speaker || '???'}
                            </span>
                            <p class="text-sm md:text-lg text-slate-300 font-serif-sc leading-relaxed bg-slate-900/30 p-2 md:p-3 rounded-lg w-full hover:bg-slate-800/50 transition-colors border-l-2 border-transparent hover:border-cyan-500/50">
                                ${item.text}
                            </p>
                        </div>
                    `)}
                    <div ref=${endRef}></div>
                </div>
            </div>
        `};

        // 8. å¿«æ·èœå•
        const QuickMenu = ({ onLog, onAuto, onSkip, isAuto, isSkip }) => html`
            <div class="absolute bottom-24 md:bottom-36 lg:bottom-56 right-2 md:right-8 z-40 flex gap-2 md:gap-4 mobile-landscape-bottom-adjust">
                <button onClick=${onLog} class="flex items-center gap-1.5 px-3 py-1.5 bg-slate-900/80 hover:bg-cyan-900/60 backdrop-blur rounded-full text-xs md:text-sm text-cyan-200 border border-cyan-500/20 hover:border-cyan-400 transition-all shadow-lg group">
                    <${Icons.FileText} size=${14} class="group-hover:scale-110 transition-transform" />
                    <span class="font-bold hidden md:inline">å›æ”¾</span>
                    <span class="font-bold md:hidden">Log</span>
                </button>
                <button onClick=${onAuto} class="flex items-center gap-1.5 px-3 py-1.5 ${isAuto ? 'bg-cyan-600/80 text-white shadow-[0_0_10px_rgba(8,145,178,0.5)]' : 'bg-slate-900/80 text-cyan-200'} hover:bg-cyan-700/80 backdrop-blur rounded-full text-xs md:text-sm border border-cyan-500/20 hover:border-cyan-400 transition-all shadow-lg group">
                    <${isAuto ? Icons.Pause : Icons.Play} size=${14} class="group-hover:scale-110 transition-transform" />
                    <span class="font-bold hidden md:inline">${isAuto ? 'è‡ªåŠ¨ä¸­' : 'è‡ªåŠ¨'}</span>
                    <span class="font-bold md:hidden">Auto</span>
                </button>
                <button onClick=${onSkip} class="flex items-center gap-1.5 px-3 py-1.5 ${isSkip ? 'bg-amber-600/80 text-white shadow-[0_0_10px_rgba(217,119,6,0.5)]' : 'bg-slate-900/80 text-cyan-200'} hover:bg-amber-700/80 backdrop-blur rounded-full text-xs md:text-sm border border-cyan-500/20 hover:border-amber-400 transition-all shadow-lg group">
                    <${Icons.FastForward} size=${14} class="group-hover:scale-110 transition-transform" />
                    <span class="font-bold hidden md:inline">${isSkip ? 'å¿«è¿›ä¸­' : 'å¿«è¿›'}</span>
                    <span class="font-bold md:hidden">Skip</span>
                </button>
            </div>
        `;

        // èƒŒæ™¯åˆ‡æ¢ç»„ä»¶ (Cross-fade)
        const BackgroundLayer = ({ src }) => {
            const [currentSrc, setCurrentSrc] = useState(src);
            const [nextSrc, setNextSrc] = useState(null);
            const [isTransitioning, setIsTransitioning] = useState(false);

            useEffect(() => {
                if (src !== currentSrc) {
                    setNextSrc(src);

                    // ä¸‹ä¸€å¸§å¯åŠ¨åŠ¨ç”»
                    requestAnimationFrame(() => {
                        setIsTransitioning(true);
                    });

                    // åŠ¨ç”»ç»“æŸåæ›´æ–°çŠ¶æ€
                    const timer = setTimeout(() => {
                        setCurrentSrc(src);
                        setNextSrc(null);
                        setIsTransitioning(false);
                    }, 1000); // 1ç§’æ·¡å…¥æ·¡å‡ºï¼Œä¸ CSS duration åŒ¹é…

                    return () => clearTimeout(timer);
                }
            }, [src, currentSrc]);

            return html`
                <div class="absolute inset-0 z-0 bg-black pointer-events-none select-none">
                    <!-- åº•å±‚ï¼šå½“å‰æ˜¾ç¤ºçš„èƒŒæ™¯ -->
                    ${currentSrc && html`<img src=${currentSrc} class="absolute inset-0 w-full h-full object-cover filter brightness-[0.6]" />`}
                    
                    <!-- é¡¶å±‚ï¼šæ·¡å…¥çš„æ–°èƒŒæ™¯ -->
                    ${nextSrc && html`<img src=${nextSrc} class="absolute inset-0 w-full h-full object-cover filter brightness-[0.6] transition-opacity duration-1000 ease-in-out ${isTransitioning ? 'opacity-100' : 'opacity-0'}" />`}
                </div>
            `;
        };

        // --- ä¸»é€»è¾‘ ---
        const App = () => {
            const [isLoading, setIsLoading] = useState(true);
            const [gameState, setGameState] = useState({
                sceneId: 'start',
                lineIndex: 0,
                bg: ASSETS.bg.bamboo,
                history: [] // å†å²è®°å½•
            });
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [isHistoryOpen, setIsHistoryOpen] = useState(false);
            // Save/Load States
            const [isSaveLoadOpen, setIsSaveLoadOpen] = useState(false);
            const [saveLoadMode, setSaveLoadMode] = useState('load'); // 'save' or 'load'
            const [refreshSaves, setRefreshSaves] = useState(0); // Trigger re-render of saves

            const [typingText, setTypingText] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [audioEnabled, setAudioEnabled] = useState(false);
            const [isAuto, setIsAuto] = useState(false);
            const [isSkip, setIsSkip] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isShaking, setIsShaking] = useState(false); // å±å¹•éœ‡åŠ¨çŠ¶æ€
            const [isRhythm, setIsRhythm] = useState(false); // æœ‰èŠ‚å¥çš„éœ‡åŠ¨çŠ¶æ€
            const [isEndingsOpen, setIsEndingsOpen] = useState(false); // ç»“å±€å›æ”¶ç•Œé¢

            // å·²è¯»æ–‡æœ¬è®°å½• (ä½¿ç”¨ Set å­˜å‚¨å·²è¯»çš„å”¯ä¸€æ ‡è¯†)
            const [readTextIds, setReadTextIds] = useState(() => {
                try {
                    const saved = Storage.get(READ_TEXT_KEY);
                    return saved ? new Set(saved) : new Set();
                } catch {
                    return new Set();
                }
            });

            // å·²è§£é”ç»“å±€è®°å½•
            const UNLOCKED_ENDINGS_KEY = 'qijiu_unlocked_endings';
            const [unlockedEndings, setUnlockedEndings] = useState(() => {
                try {
                    const saved = Storage.get(UNLOCKED_ENDINGS_KEY);
                    return saved ? new Set(saved) : new Set();
                } catch {
                    return new Set();
                }
            });

            // å·²è§£é”ç« èŠ‚è®°å½•
            const UNLOCKED_CHAPTERS_KEY = 'qijiu_unlocked_chapters';
            const [unlockedChapters, setUnlockedChapters] = useState(() => {
                try {
                    const saved = Storage.get(UNLOCKED_CHAPTERS_KEY);
                    // é»˜è®¤è§£é”ç¬¬ä¸€ç« 
                    return saved ? new Set(saved) : new Set(['chapter1']);
                } catch {
                    return new Set(['chapter1']);
                }
            });
            const [isChaptersOpen, setIsChaptersOpen] = useState(false); // ç« èŠ‚é€‰æ‹©ç•Œé¢

            // Settings
            const SETTINGS_KEY = 'qijiu_settings';
            const loadSettings = () => {
                try {
                    const saved = Storage.get(SETTINGS_KEY);
                    return saved || { textSpeed: 30 };
                } catch { return { textSpeed: 30 }; }
            };
            const [textSpeed, setTextSpeed] = useState(() => loadSettings().textSpeed);

            const handleTextSpeedChange = (newSpeed) => {
                setTextSpeed(newSpeed);
                const result = Storage.set(SETTINGS_KEY, { textSpeed: newSpeed });
                if (!result.success) {
                    console.warn('ä¿å­˜è®¾ç½®å¤±è´¥:', result.error);
                }
            };

            const audioRef = useRef(new Audio(ASSETS.audio.bgm));
            const timerRef = useRef(null);
            const autoTimerRef = useRef(null);

            const AUTO_SAVE_KEY = 'qijiu_auto_save';
            const SAVE_SLOT_PREFIX = 'qijiu_save_slot_';
            const READ_TEXT_KEY = 'qijiu_read_text'; // å·²è¯»æ–‡æœ¬è®°å½•

            // çŠ¶æ€å†å²æ ˆ (ç”¨äºå›é€€åŠŸèƒ½)
            const [stateHistory, setStateHistory] = useState([]);

            // æ’­æ”¾ BGM
            useEffect(() => {
                const audio = audioRef.current;
                audio.loop = true;
                audio.volume = 0.4;
                // Init: ensure pause
                audio.pause();
                return () => { audio.pause(); };
            }, []);

            const toggleAudio = (e) => {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                const nextState = !audioEnabled;
                setAudioEnabled(nextState);

                const audio = audioRef.current;
                if (nextState) {
                    // Mobile: Play directly in user event
                    const playPromise = audio.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.error("Audio play failed / blocked:", error);
                            setAudioEnabled(false); // Revert state if blocked
                        });
                    }
                } else {
                    audio.pause();
                }
            };

            // Remove previous side-effect for BGM to avoid loop/freeze
            // useEffect(() => { ... }, [audioEnabled]); 

            // åœºæ™¯æ•°æ®è·å–
            const currentScene = SCENES[gameState.sceneId];
            const currentLine = currentScene?.lines ? currentScene.lines[gameState.lineIndex] : null;

            // æ‰“å­—æœºä¸Auto/Skipé€»è¾‘
            useEffect(() => {
                if (!currentLine) return;

                // è‡ªåŠ¨è§£é”å½“å‰ç« èŠ‚
                if (CHAPTERS_META[gameState.sceneId] && !unlockedChapters.has(gameState.sceneId)) {
                    const newUnlocked = new Set(unlockedChapters);
                    newUnlocked.add(gameState.sceneId);
                    setUnlockedChapters(newUnlocked);
                    const result = Storage.set(UNLOCKED_CHAPTERS_KEY, [...newUnlocked]);
                    if (!result.success) {
                        console.error('ä¿å­˜ç« èŠ‚è§£é”è®°å½•å¤±è´¥:', result.error);
                    }
                }

                // ç”Ÿæˆå½“å‰è¡Œçš„å”¯ä¸€æ ‡è¯†
                const textId = `${gameState.sceneId}_${gameState.lineIndex}`;

                // æ£€æŸ¥å½“å‰æ–‡æœ¬æ˜¯å¦å·²è¯»
                const isCurrentTextRead = readTextIds.has(textId);

                // å¦‚æœæ˜¯Skipæ¨¡å¼ä½†é‡åˆ°æœªè¯»æ–‡æœ¬ï¼Œè‡ªåŠ¨åœæ­¢Skip
                if (isSkip && !isCurrentTextRead) {
                    setIsSkip(false);
                    // å¯é€‰ï¼šæ˜¾ç¤ºæç¤º
                    // console.log('é‡åˆ°æœªè¯»æ–‡æœ¬ï¼Œåœæ­¢å¿«è¿›');
                }

                // èƒŒæ™¯åˆ‡æ¢
                if (currentLine.bg) {
                    setGameState(prev => ({ ...prev, bg: currentLine.bg }));
                }

                // éŸ³æ•ˆ
                if (currentLine.sound && audioEnabled && !isSkip) { // Skipæ—¶ä¸æ’­æ”¾éŸ³æ•ˆæˆ–ç”±æµè§ˆå™¨è‡ªåŠ¨å¤„ç†ï¼ˆå¯èƒ½ä¼šå †å ï¼Œè¿™é‡Œç®€å•å¤„ç†ä¸ºä¸æ’­æ”¾ï¼‰
                    const sfx = new Audio(currentLine.sound);
                    sfx.volume = 0.6;
                    sfx.play().catch(() => { });
                }

                // å±å¹•éœ‡åŠ¨
                if (currentLine.shake && !isSkip) {
                    setIsShaking(true);
                    setTimeout(() => setIsShaking(false), 600);
                }

                // æœ‰èŠ‚å¥çš„éœ‡åŠ¨ï¼ˆæŒç»­æ•´è¡Œæ–‡å­—ï¼‰
                if (currentLine.rhythm && !isSkip) {
                    setIsRhythm(true);
                } else {
                    setIsRhythm(false);
                }

                const text = currentLine.text;

                // å¦‚æœæ˜¯Skipæ¨¡å¼ä¸”æ–‡æœ¬å·²è¯»ï¼Œç›´æ¥æ˜¾ç¤ºå…¨éƒ¨
                if (isSkip && isCurrentTextRead) {
                    setTypingText(text);
                    setIsTyping(false);

                    // æçŸ­å»¶è¿Ÿåè·³è½¬
                    if (autoTimerRef.current) clearTimeout(autoTimerRef.current);
                    autoTimerRef.current = setTimeout(() => {
                        handleNext(true); // true è¡¨ç¤ºè‡ªåŠ¨è§¦å‘
                    }, 100);
                    return;
                }

                setTypingText('');
                setIsTyping(true);
                let idx = 0;

                if (timerRef.current) clearInterval(timerRef.current);

                // æ­£å¸¸æ‰“å­— - ä½¿ç”¨ textSpeed å˜é‡
                timerRef.current = setInterval(() => {
                    if (idx < text.length) {
                        setTypingText(text.substring(0, idx + 1));
                        idx++;
                    } else {
                        setIsTyping(false);
                        clearInterval(timerRef.current);
                    }
                }, textSpeed);

                return () => {
                    clearInterval(timerRef.current);
                    if (autoTimerRef.current) clearTimeout(autoTimerRef.current);
                };
            }, [gameState.lineIndex, gameState.sceneId, isSkip]); // ç§»é™¤ readTextIds å’Œ audioEnabled ä»¥é˜²æ­¢æ‰“å­—ä¸­é€”é‡ç½®

            // Auto Mode ç›‘å¬
            useEffect(() => {
                if (isAuto && !isTyping && !isSkip && currentScene?.lines) {
                    // è®¡ç®—é˜…è¯»æ—¶é—´ï¼šåŸºç¡€0.5ç§’ + æ¯å­—80ms (å¤§å¹…åŠ å¿«)
                    const delay = 500 + (currentLine?.text?.length || 0) * 80;
                    if (autoTimerRef.current) clearTimeout(autoTimerRef.current);
                    autoTimerRef.current = setTimeout(() => {
                        handleNext(true);
                    }, delay);
                }
                return () => {
                    if (autoTimerRef.current && !isSkip) clearTimeout(autoTimerRef.current);
                };
            }, [isAuto, isTyping, gameState.lineIndex]); // ä¾èµ– lineIndex ç¡®ä¿æ¢è¡Œåé‡ç½®å®šæ—¶å™¨

            const prevGameState = useRef({ sceneId: 'start' });

            useEffect(() => {
                const currentSceneId = gameState.sceneId;
                if (currentSceneId === 'start') {
                    prevGameState.current = gameState;
                    return;
                }
                const prevState = prevGameState.current;
                const prevScene = SCENES[prevState.sceneId];
                const prevIsChoice = prevScene?.type === 'choice';
                const prevIsStart = prevState.sceneId === 'start';

                if (!prevIsStart && !prevIsChoice) {
                    const result = Storage.set(AUTO_SAVE_KEY, {
                        ...prevState,
                        timestamp: Date.now()
                    });
                    if (!result.success) {
                        console.warn('è‡ªåŠ¨å­˜æ¡£å¤±è´¥:', result.error);
                    }
                }
                prevGameState.current = gameState;
            }, [gameState]);


            // --- New Save/Load Logic ---
            const getAllSaves = () => {
                const saves = {};
                for (let i = 1; i <= 12; i++) {
                    const data = Storage.get(`${SAVE_SLOT_PREFIX}${i}`);
                    if (data) saves[i] = data;
                }
                return saves;
            };

            const handleSaveSlot = (slotId) => {
                const existingData = Storage.get(`${SAVE_SLOT_PREFIX}${slotId}`);
                // Improve prompt logic
                const promptMsg = existingData
                    ? `æ˜¯å¦è¦†ç›– å­˜æ¡£ ${slotId} ?`
                    : `æ˜¯å¦åœ¨ å­˜æ¡£ ${slotId} åˆ›å»ºæ–°å­˜æ¡£?`;

                if (window.confirm(promptMsg)) {
                    const saveData = {
                        ...gameState,
                        timestamp: Date.now(),
                        previewText: currentLine?.text || 'å‰§æƒ…ç‰‡æ®µ',
                        speaker: currentLine?.speaker || 'æ—ç™½'
                    };
                    const result = Storage.set(`${SAVE_SLOT_PREFIX}${slotId}`, saveData);
                    if (result.success) {
                        setRefreshSaves(prev => prev + 1);
                        alert(`å­˜æ¡£ ${slotId} ä¿å­˜æˆåŠŸï¼`);
                    } else {
                        alert(`å­˜æ¡£ ${slotId} ä¿å­˜å¤±è´¥ï¼š${result.error || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                }
            };

            const handleLoadSlot = (slotId) => {
                const data = Storage.get(`${SAVE_SLOT_PREFIX}${slotId}`);
                if (data) {
                    if (window.confirm(`è¯»å–å­˜æ¡£ ${slotId} ?\nå½“å‰æœªä¿å­˜çš„è¿›åº¦å°†ä¸¢å¤±ã€‚`)) {
                        setGameState(data);
                        setIsSaveLoadOpen(false);
                        setIsMenuOpen(false);
                        setIsHistoryOpen(false);
                        setIsAuto(false);
                        setIsSkip(false);
                    }
                }
            };

            const handleDeleteSlot = (slotId) => {
                if (window.confirm(`ç¡®è®¤åˆ é™¤å­˜æ¡£ ${slotId} ?`)) {
                    const success = Storage.remove(`${SAVE_SLOT_PREFIX}${slotId}`);
                    if (success) {
                        setRefreshSaves(prev => prev + 1);
                    } else {
                        console.warn('åˆ é™¤å­˜æ¡£å¤±è´¥');
                    }
                }
            };

            const loadAutoSave = () => {
                const data = Storage.get(AUTO_SAVE_KEY);
                if (data) {
                    setGameState(data);
                } else {
                    alert('æ²¡æœ‰æ‰¾åˆ°è‡ªåŠ¨å­˜æ¡£');
                }
            };

            // --- Navigation Logic ---
            const handleNext = (isAutoTrigger = false) => {
                // æ ‡è®°å½“å‰æ–‡æœ¬ä¸ºå·²è¯»
                const textId = `${gameState.sceneId}_${gameState.lineIndex}`;
                if (!readTextIds.has(textId)) {
                    const newReadTextIds = new Set(readTextIds);
                    newReadTextIds.add(textId);
                    setReadTextIds(newReadTextIds);
                    // ä¿å­˜åˆ° localStorage
                    const result = Storage.set(READ_TEXT_KEY, [...newReadTextIds]);
                    if (!result.success) {
                        console.error('ä¿å­˜å·²è¯»è®°å½•å¤±è´¥:', result.error);
                    }
                }

                // å¦‚æœæ˜¯ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»
                if (!isAutoTrigger) {
                    // å¦‚æœæ­£åœ¨Skipï¼Œåœæ­¢Skip
                    if (isSkip) setIsSkip(false);
                    // å¦‚æœæ­£åœ¨Autoï¼Œåœæ­¢Auto
                    if (isAuto) setIsAuto(false);

                    if (isTyping) {
                        clearInterval(timerRef.current);
                        setTypingText(currentLine.text);
                        setIsTyping(false);
                        return;
                    }
                }

                if (currentScene.lines) {
                    // è®°å½•å†å²
                    const newHistoryItem = { speaker: currentLine.speaker, text: currentLine.text };

                    // ä¿å­˜å½“å‰çŠ¶æ€åˆ°å†å²æ ˆ (ç”¨äºå›é€€)
                    setStateHistory(prev => [...prev.slice(-50), { ...gameState }]); // æœ€å¤šä¿å­˜50æ¡

                    if (gameState.lineIndex < currentScene.lines.length - 1) {
                        setGameState(prev => ({
                            ...prev,
                            lineIndex: prev.lineIndex + 1,
                            history: [...prev.history, newHistoryItem]
                        }));
                    } else {
                        // ç« èŠ‚ç»“æŸ
                        if (currentScene.next) {
                            // æ£€æŸ¥ä¸‹ä¸€ç« æ˜¯å¦æ˜¯Endingæˆ–Choice
                            const nextScene = SCENES[currentScene.next];

                            // ä¿å­˜æœ¬ç« æœ€åä¸€å¥åˆ°å†å²
                            setGameState(prev => {
                                const nextHistory = [...prev.history, newHistoryItem];
                                return {
                                    sceneId: currentScene.next,
                                    lineIndex: 0,
                                    bg: nextScene.type === 'choice' ? prev.bg : (nextScene.lines?.[0]?.bg || prev.bg),
                                    history: nextHistory
                                };
                            });
                        }
                    }
                }
            };

            // å›é€€åˆ°ä¸Šä¸€å¥
            const handleBack = () => {
                if (stateHistory.length === 0) return;

                // åœæ­¢è‡ªåŠ¨/å¿«è¿›æ¨¡å¼
                setIsAuto(false);
                setIsSkip(false);

                // å–å‡ºä¸Šä¸€ä¸ªçŠ¶æ€
                const prevState = stateHistory[stateHistory.length - 1];
                setStateHistory(prev => prev.slice(0, -1));
                setGameState(prevState);
            };

            const handleChoice = (option) => {
                // é€‰é¡¹è¢«ç‚¹å‡»æ—¶ï¼Œåœæ­¢ Auto/Skip
                setIsAuto(false);
                setIsSkip(false);

                setGameState(prev => ({
                    sceneId: option.next,
                    lineIndex: 0,
                    bg: prev.bg,
                    history: prev.history // å†å²è®°å½•ä¿ç•™
                }));
            };

            const renderContent = () => {
                if (gameState.sceneId === 'start') {
                    return html`<${StartScreen} 
                        onStart=${() => {
                            setGameState({ sceneId: 'chapter1', lineIndex: 0, bg: ASSETS.bg.qiancao, history: [] });
                            setStateHistory([]); // æ¸…ç©ºå›é€€å†å²
                        }} 
                        onLoad=${(type) => {
                            if (type === 'manual') {
                                setSaveLoadMode('load');
                                setIsSaveLoadOpen(true);
                            } else {
                                loadAutoSave();
                            }
                        }}
                        hasAutoSave=${!!Storage.get(AUTO_SAVE_KEY)}
                        onEndings=${() => setIsEndingsOpen(true)}
                        onChapters=${() => setIsChaptersOpen(true)}
                        unlockedEndingsCount=${unlockedEndings.size}
                        unlockedChaptersCount=${unlockedChapters.size}
                        totalChapters=${TOTAL_CHAPTERS}
                    />`;
                }

                if (currentScene?.type === 'choice') {
                    // Choiceæ—¶ åœæ­¢ Auto/Skip (åŒé‡ä¿é™©)
                    if (isAuto) setIsAuto(false);
                    if (isSkip) setIsSkip(false);
                    return html`<${ChoiceScreen} question=${currentScene.question} options=${currentScene.options} onChoice=${handleChoice} />`;
                }

                if (currentScene?.type === 'ending') {
                    // è§£é”å½“å‰ç»“å±€
                    if (!unlockedEndings.has(gameState.sceneId)) {
                        const newUnlocked = new Set(unlockedEndings);
                        newUnlocked.add(gameState.sceneId);
                        setUnlockedEndings(newUnlocked);
                        const result = Storage.set(UNLOCKED_ENDINGS_KEY, [...newUnlocked]);
                        if (!result.success) {
                            console.error('ä¿å­˜ç»“å±€è§£é”è®°å½•å¤±è´¥:', result.error);
                        }
                    }

                    // ç»“å±€æ—¶ï¼Œé‡ç½®æ‰€æœ‰çŠ¶æ€
                    return html`
                        <div class="absolute inset-0 flex items-center justify-center bg-black/80 z-40 p-2 md:p-8 text-center animate-in fade-in duration-1000">
                             <div class="ending-container-mobile-landscape max-w-3xl w-full h-full flex flex-col items-center justify-center relative">
                                <h1 class="ending-title-mobile-landscape text-3xl md:text-5xl font-calligraphy text-amber-500 mb-2 md:mb-6 tracking-widest drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] shrink-0">${currentScene.title}</h1>
                                ${currentScene.text && html`<p class="ending-text-mobile-landscape text-slate-300 text-sm md:text-xl leading-relaxed text-left mx-auto mb-4 md:mb-10 font-serif-sc p-4 md:p-6 bg-slate-900/50 rounded-lg border border-slate-700/50 overflow-y-auto">${currentScene.text}</p>`}
                                <button onClick=${() => {
                            setGameState({ sceneId: 'start', lineIndex: 0, bg: ASSETS.bg.qingjing, history: [] });
                            setIsAuto(false);
                            setIsSkip(false);
                            setStateHistory([]); // æ¸…ç©ºå›é€€å†å²
                        }} class="ending-btn-mobile-landscape px-6 py-2 md:px-10 md:py-3 bg-gradient-to-r from-slate-800 to-slate-700 hover:from-slate-700 hover:to-slate-600 border border-slate-500 text-slate-100 rounded text-base md:text-xl font-serif-sc tracking-widest shadow-lg transition-transform hover:scale-105 shrink-0">
                                    è¿”å›æ ‡é¢˜
                                </button>
                             </div>
                        </div>
                     `;
                }

                const speaker = currentLine?.speaker;
                const isSQQ = speaker === 'æ²ˆæ¸…ç§‹';
                const isYQY = speaker === 'å²³æ¸…æº';
                const isNarrative = !speaker || speaker === 'æ—ç™½';

                return html`
                    <div class="absolute inset-0 z-10 flex items-end justify-center pointer-events-none">
                        <div class="w-1/2 h-full max-w-[500px] relative transition-all duration-500 ease-out ${isYQY ? 'translate-y-0 opacity-100 scale-105 z-20' : 'translate-y-4 opacity-0 scale-95 z-10'}">
                            <img src=${ASSETS.char.yqy} class="char-sprite absolute bottom-0 left-1/2 md:left-[40%] -translate-x-1/2 h-[85%] object-contain object-bottom" />
                        </div>
                        <div class="w-1/2 h-full max-w-[500px] relative transition-all duration-500 ease-out ${isSQQ ? 'translate-y-0 opacity-100 scale-105 z-20' : 'translate-y-4 opacity-0 scale-95 z-10'}">
                            ${(() => {
                        // æ²ˆæ¸…ç§‹ç«‹ç»˜æ˜ å°„é€»è¾‘ (5å¼ å›¾ç‰ˆæœ¬)
                        const mood = currentLine?.mood || 'neutral';
                        let spriteSrc = ASSETS.char.sqq.v1; // é»˜è®¤ï¼šæ­£å¸¸

                        if (['angry', 'disdain', 'determined', 'neutral'].includes(mood)) {
                            spriteSrc = ASSETS.char.sqq.v1; // 1. æ­£å¸¸
                        } else if (['despair', 'sorrow', 'sleep'].includes(mood)) {
                            spriteSrc = ASSETS.char.sqq.v2; // 2. é—­çœ¼
                        } else if (['pain'].includes(mood)) {
                            spriteSrc = ASSETS.char.sqq.v3; // 3. é—­çœ¼è„¸çº¢
                        } else if (['shocked', 'soft', 'worried', 'surprised'].includes(mood)) {
                            spriteSrc = ASSETS.char.sqq.v4; // 4. ç›®å…‰èº²é—ª
                        } else if (['shame', 'dark'].includes(mood)) {
                            spriteSrc = ASSETS.char.sqq.v5; // 5. ç›®å…‰èº²é—ª+è„¸çº¢
                        }

                        return html`<img src=${spriteSrc} class="char-sprite absolute bottom-0 left-1/2 md:left-[60%] -translate-x-1/2 h-[85%] object-contain object-bottom" />`;
                    })()}
                        </div>
                    </div>

                    <div class="absolute bottom-0 w-full z-30 pb-0">
                        <${DialogueBox} 
                            speaker=${speaker} 
                            text=${currentLine?.text} 
                            typingText=${typingText}
                            isTyping=${isTyping}
                            onNext=${() => handleNext(false)} 
                            isNarrative=${isNarrative}
                            onLog=${() => setIsHistoryOpen(true)}
                            onAuto=${() => { setIsAuto(!isAuto); setIsSkip(false); }}
                            onSkip=${() => {
                        // æ£€æŸ¥å½“å‰æ–‡æœ¬æ˜¯å¦å·²è¯»
                        const textId = `${gameState.sceneId}_${gameState.lineIndex}`;
                        const canSkip = readTextIds.has(textId);
                        if (!isSkip && !canSkip) {
                            // å¦‚æœå½“å‰æ–‡æœ¬æœªè¯»ï¼Œä¸å…è®¸å¼€å¯å¿«è¿›
                            alert('åªèƒ½å¿«è¿›å·²è¯»è¿‡çš„å‰§æƒ…å“¦ï¼');
                            return;
                        }
                        setIsSkip(!isSkip);
                        setIsAuto(false);
                    }}
                            onBack=${handleBack}
                            canGoBack=${stateHistory.length > 0}
                            isAuto=${isAuto}
                            isSkip=${isSkip}
                        />
                    </div>

                    <!-- é¡¶éƒ¨èœå•æŒ‰é’® (æ‰‹æœºç«¯ä»…å›¾æ ‡) -->
                    <button onClick=${() => setIsMenuOpen(true)} class="absolute top-2 left-2 md:top-4 md:left-4 z-40 p-2 md:px-4 md:py-2 bg-slate-900/80 rounded-full hover:bg-slate-800 text-cyan-500 backdrop-blur border border-cyan-500/30 flex items-center gap-2 shadow-lg transition-all group highlight-none">
                        <${Icons.Menu} size=${18} />
                        <span class="menu-label font-bold text-sm group-hover:text-cyan-300 hidden md:inline">èœå•</span>
                    </button>
                `;
            };

            return html`
                <div class="w-full h-full bg-black flex items-center justify-center overflow-hidden relative">
                    ${isLoading ? html`<${Preloader} onLoadComplete=${() => setIsLoading(false)} />` : null}
                    
                    <div class="${`relative shadow-2xl bg-slate-900 overflow-hidden m-auto group/game flex-shrink-0 ${isShaking ? 'screen-shake' : ''} ${isRhythm ? 'screen-rhythm' : ''}`}" 
                         style="width: min(100%, 177.78dvh); aspect-ratio: 16/9;">
                        
                        <${BackgroundLayer} src=${gameState.bg} />

                        ${renderContent()}

                        <button onClick=${toggleAudio} class="volume-btn-mobile absolute top-2 right-2 md:top-4 md:right-4 z-[60] p-2 md:p-3 text-cyan-500 hover:text-cyan-300 transition-all drop-shadow-lg hover:scale-110 active:scale-95" title="éŸ³ä¹å¼€å…³">
                             ${audioEnabled ? html`<${Icons.Volume2} size=${24} class="md:w-8 md:h-8 filter drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]" />` : html`<${Icons.VolumeX} size=${24} class="md:w-8 md:h-8 text-slate-500 filter drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]" />`}
                        </button>

                        ${isMenuOpen && html`<${Menu}  
                            onClose=${() => setIsMenuOpen(false)} 
                            onOpenSave=${() => { setSaveLoadMode('save'); setIsSaveLoadOpen(true); }}
                            onOpenLoad=${() => { setSaveLoadMode('load'); setIsSaveLoadOpen(true); }}
                            onOpenSettings=${() => { setIsSettingsOpen(true); setIsMenuOpen(false); }}
                            onBackTitle=${() => {
                        setGameState({ sceneId: 'start', lineIndex: 0, bg: ASSETS.bg.bamboo, history: [] });
                        setIsMenuOpen(false);
                    }}
                        />`}

                        ${isHistoryOpen && html`<${HistoryModal}
                            history=${gameState.history}
                            onClose=${() => setIsHistoryOpen(false)}
                        />`}

                        ${isSaveLoadOpen && html`<${SaveLoadScreen} 
                            mode=${saveLoadMode}
                            saves=${getAllSaves()}
                            onClose=${() => setIsSaveLoadOpen(false)}
                            onSave=${handleSaveSlot}
                            onLoad=${handleLoadSlot}
                            onDelete=${handleDeleteSlot}
                        />`}

                        ${isSettingsOpen && html`<${SettingsScreen}
                            textSpeed=${textSpeed}
                            onTextSpeedChange=${handleTextSpeedChange}
                            onClose=${() => setIsSettingsOpen(false)}
                        />`}

                        ${isEndingsOpen && html`<${EndingsScreen}
                            unlockedEndings=${unlockedEndings}
                            onClose=${() => setIsEndingsOpen(false)}
                            onSelectEnding=${(endingId) => {
                        const ending = SCENES[endingId];
                        if (ending) {
                            setGameState({
                                sceneId: endingId,
                                lineIndex: 0,
                                bg: ending.bg || ASSETS.bg.bamboo,
                                history: []
                            });
                            setStateHistory([]);
                            setIsEndingsOpen(false);
                        }
                    }}
                        />`}

                        ${isChaptersOpen && html`<${ChaptersScreen}
                            unlockedChapters=${unlockedChapters}
                            onClose=${() => setIsChaptersOpen(false)}
                            onSelectChapter=${(chapterId) => {
                        const chapter = SCENES[chapterId];
                        if (chapter) {
                            setGameState({
                                sceneId: chapterId,
                                lineIndex: 0,
                                bg: chapter.lines?.[0]?.bg || ASSETS.bg.qiancao,
                                history: []
                            });
                            setStateHistory([]);
                            setIsChaptersOpen(false);
                        }
                    }}
                        />`}
                    </div>
                </div>
            `;
        };

        render(html`<${App} />`, document.getElementById('app-root'));
    </script>
</body>

</html>
# 任务 7 详解：添加可访问性支持

## 🎯 任务目标

让游戏更易用，特别是为**键盘用户**和**屏幕阅读器用户**提供更好的体验。

---

## 📖 什么是可访问性（Accessibility）？

**简单来说**：让更多人能够舒服地玩你的游戏。

### 当前问题 ❌

1. **必须用鼠标** - 键盘用户玩不了
2. **屏幕阅读器看不懂** - 视障用户无法理解界面
3. **焦点不明显** - 用 Tab 键不知道选中了什么

### 改进后 ✅

1. **键盘也能玩** - 按空格推进、ESC 开菜单
2. **屏幕阅读器友好** - 会读出"开始游戏按钮"
3. **焦点清晰** - Tab 键导航很清楚

---

## 📝 具体会做什么？

### 第一部分：添加 ARIA 标签（15分钟）

**ARIA** = Accessible Rich Internet Applications（无障碍富互联网应用）

#### 什么是 ARIA 标签？

就是给 HTML 元素加上"说明标签"，让屏幕阅读器能读出来。

#### 示例对比

**改进前**：

```html
<button onClick=${startGame}>
    开始新游戏
</button>
```

屏幕阅读器读：_"按钮，开始新游戏"_（还行，但不够详细）

**改进后**：

```html
<button 
    onClick=${startGame}
    aria-label="开始新游戏"
    aria-describedby="start-game-description"
>
    开始新游戏
</button>
```

屏幕阅读器读：_"开始新游戏按钮，点击开始一个新的游戏存档"_（很清楚！）

#### 会添加的 ARIA 标签

| 位置 | 添加的标签 | 作用 |
|------|-----------|------|
| 所有按钮 | `aria-label` | 说明按钮的作用 |
| 菜单 | `role="menu"` | 标识这是菜单 |
| 对话框 | `role="dialog"` | 标识这是对话框 |
| 选项 | `aria-selected` | 标识当前选中的选项 |

---

### 第二部分：添加键盘导航（20-30分钟）

**目标**：不用鼠标，只用键盘就能玩整个游戏！

#### 会添加的键盘快捷键

| 按键 | 功能 | 说明 |
|------|------|------|
| **Space** | 推进对话 | 最常用，快速推进剧情 |
| **Enter** | 推进对话 / 确认选择 | 通用确认键 |
| **ESC** | 打开/关闭菜单 | 快速访问菜单 |
| **↑ ↓** | 导航选项 | 在选择题中上下移动 |
| **Tab** | 切换焦点 | 在按钮间移动焦点 |

#### 实现方式

在游戏主组件添加全局键盘事件监听：

```javascript
useEffect(() => {
    const handleKeyDown = (e) => {
        // ESC 键 - 打开/关闭菜单
        if (e.key === 'Escape') {
            setIsMenuOpen(!isMenuOpen);
        }
        
        // Space/Enter - 推进对话（当没有菜单打开时）
        if ((e.key === ' ' || e.key === 'Enter') && !isMenuOpen) {
            e.preventDefault();  // 防止页面滚动
            handleNext(false);   // 推进到下一句
        }
        
        // 方向键 - 导航选项（在选择界面时）
        if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
            // 选项导航逻辑
        }
    };
    
    document.addEventListener('keydown', handleKeyDown);
    return () => document.removeEventListener('keydown', handleKeyDown);
}, [isMenuOpen, currentScene]);
```

#### 效果演示

**玩家体验**：

```
1. 游戏开始界面
   → 按 Enter → 开始游戏
   
2. 对话场景
   → 按 Space → 下一句
   → 按 Space → 下一句
   → 按 ESC → 打开菜单
   
3. 选择界面
   → 按 ↓ → 选择下一个选项
   → 按 ↑ → 选择上一个选项
   → 按 Enter → 确认选择
```

---

### 第三部分：焦点管理（10-15分钟）

**焦点** = 当前选中的元素（用 Tab 键切换）

#### 问题：焦点不明显

**当前**：按 Tab 键，看不出选中了哪个按钮 ❌

**改进后**：按 Tab 键，选中的按钮有明显的高亮边框 ✅

#### 实现方式

##### 1. 添加焦点样式

```css
/* 为所有可聚焦元素添加明显的焦点样式 */
button:focus-visible,
a:focus-visible {
    outline: 3px solid #60a5fa;  /* 蓝色高亮边框 */
    outline-offset: 2px;
    box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.2);
}
```

##### 2. 自动聚焦管理

**对话框打开时**：

```javascript
const dialogRef = useRef(null);

useEffect(() => {
    if (isMenuOpen && dialogRef.current) {
        // 对话框打开时，自动聚焦第一个按钮
        const firstButton = dialogRef.current.querySelector('button');
        firstButton?.focus();
    }
}, [isMenuOpen]);
```

**对话框关闭时**：

```javascript
// 记住关闭前的焦点元素
const previousFocus = useRef(null);

const openDialog = () => {
    previousFocus.current = document.activeElement;
    setIsMenuOpen(true);
};

const closeDialog = () => {
    setIsMenuOpen(false);
    // 恢复之前的焦点
    previousFocus.current?.focus();
};
```

---

## 🎁 完成后的好处

### 1. 键盘用户友好 ⌨️

**场景**：玩家用笔记本电脑，不想用触摸板

**改进前**：

- ❌ 必须用鼠标点击
- ❌ 玩起来很累

**改进后**：

- ✅ 一只手按空格就能玩
- ✅ 超级流畅

### 2. 屏幕阅读器友好 🔊

**场景**：视障玩家使用屏幕阅读器

**改进前**：

- ❌ "按钮" "按钮" "按钮"（不知道是什么）
- ❌ 无法理解界面结构

**改进后**：

- ✅ "开始新游戏按钮"
- ✅ "继续游戏按钮"
- ✅ "设置菜单对话框"

### 3. 焦点管理清晰 🎯

**改进前**：

- ❌ 按 Tab 键，不知道选中了什么
- ❌ 对话框打开，焦点仍在背景

**改进后**：

- ✅ 选中的按钮有明显高亮
- ✅ 对话框打开自动聚焦
- ✅ 关闭后焦点回到原位

### 4. 专业度提升 📈

- ✅ 符合 Web 可访问性标准（WCAG）
- ✅ 体现对用户的关怀
- ✅ 用户体验大幅提升

---

## ⏱️ 时间预估

| 步骤 | 工作内容 | 预计时间 |
|------|---------|---------|
| 1 | 添加 ARIA 标签 | 15 分钟 |
| 2 | 添加键盘导航 | 20-30 分钟 |
| 3 | 焦点管理 | 10-15 分钟 |
| 4 | 测试验证 | 10 分钟 |
| **总计** | | **45-60 分钟** |

---

## 🛡️ 风险评估

| 风险项 | 评估 | 说明 |
|--------|------|------|
| 引入新 Bug | 🟡 中等 | 需要添加事件监听，可能有冲突 |
| 破坏现有功能 | 🟢 低 | 主要是增强，不改变核心逻辑 |
| 测试成本 | 🟡 中等 | 需要测试键盘操作流程 |
| 学习成本 | 🟢 低 | 改进后反而更好用 |

**总体风险**：🟡 **中等偏低**

---

## 📋 具体实施步骤

### 步骤 1：添加 ARIA 标签（15分钟）

#### 位置 1：开始界面按钮

```javascript
// 在开始界面
<button 
    onClick=${() => startNewGame()}
    aria-label="开始新游戏"
    class="..."
>
    开始新游戏
</button>

<button 
    onClick=${() => loadGame()}
    aria-label="继续游戏，加载已保存的存档"
    class="..."
>
    继续游戏
</button>
```

#### 位置 2：菜单对话框

```javascript
<div 
    role="dialog" 
    aria-labelledby="menu-title"
    aria-modal="true"
    class="..."
>
    <h2 id="menu-title">游戏菜单</h2>
    <!-- 菜单内容 -->
</div>
```

#### 位置 3：选项按钮

```javascript
<div role="menu" aria-label="剧情选择">
    ${choices.map((choice, index) => html`
        <button
            role="menuitem"
            aria-label=${`选项${index + 1}：${choice.text}`}
            onClick=${() => handleChoice(choice)}
        >
            ${choice.text}
        </button>
    `)}
</div>
```

---

### 步骤 2：添加键盘导航（20-30分钟）

#### 2.1 全局键盘事件

在 `App` 组件中添加：

```javascript
useEffect(() => {
    const handleKeyDown = (e) => {
        // 获取当前状态
        const isDialogOpen = isMenuOpen || isHistoryOpen;
        
        // ESC - 打开/关闭菜单
        if (e.key === 'Escape') {
            e.preventDefault();
            setIsMenuOpen(!isMenuOpen);
            return;
        }
        
        // Space/Enter - 推进对话（没有对话框时）
        if ((e.key === ' ' || e.key === 'Enter') && !isDialogOpen) {
            e.preventDefault();
            if (currentScene === 'game') {
                handleNext(false);
            }
            return;
        }
        
        // 方向键 - 在选择界面导航
        if (currentScene === 'choices') {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                // 移动到下一个选项
            }
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                // 移动到上一个选项
            }
        }
    };
    
    document.addEventListener('keydown', handleKeyDown);
    return () => document.removeEventListener('keydown', handleKeyDown);
}, [isMenuOpen, isHistoryOpen, currentScene]);
```

#### 2.2 选项导航

```javascript
const [selectedChoiceIndex, setSelectedChoiceIndex] = useState(0);

// 方向键处理
const handleChoiceNavigation = (direction) => {
    if (direction === 'up') {
        setSelectedChoiceIndex(i => i > 0 ? i - 1 : choices.length - 1);
    } else {
        setSelectedChoiceIndex(i => i < choices.length - 1 ? i + 1 : 0);
    }
};

// 在选择按钮上添加选中状态
<button
    className={selectedChoiceIndex === index ? 'selected' : ''}
    aria-selected={selectedChoiceIndex === index}
>
```

---

### 步骤 3：焦点管理（10-15分钟）

#### 3.1 添加焦点样式

在 CSS 中添加：

```css
/* 明显的焦点样式 */
*:focus-visible {
    outline: 3px solid #60a5fa;
    outline-offset: 2px;
    box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.2);
}

/* 按钮焦点特殊样式 */
button:focus-visible {
    transform: scale(1.02);
    transition: transform 0.2s;
}
```

#### 3.2 对话框焦点管理

```javascript
const Menu = ({ isOpen, onClose }) => {
    const menuRef = useRef(null);
    const previousFocus = useRef(null);
    
    useEffect(() => {
        if (isOpen) {
            // 保存当前焦点
            previousFocus.current = document.activeElement;
            
            // 聚焦到对话框的第一个按钮
            const firstButton = menuRef.current?.querySelector('button');
            firstButton?.focus();
        } else {
            // 恢复焦点
            previousFocus.current?.focus();
        }
    }, [isOpen]);
    
    return html`
        <div ref=${menuRef} role="dialog">
            <!-- 菜单内容 -->
        </div>
    `;
};
```

---

### 步骤 4：测试验证（10分钟）

#### 测试清单

**键盘导航测试**：

- [ ] 按 Tab 键能在所有按钮间切换
- [ ] 按 Space 能推进对话
- [ ] 按 Enter 能确认选择
- [ ] 按 ESC 能打开/关闭菜单
- [ ] 按方向键能导航选项
- [ ] 焦点样式清晰可见

**屏幕阅读器测试**（可选）：

- [ ] 打开 Windows 讲述人（Win + Ctrl + Enter）
- [ ] 听屏幕阅读器是否正确读出按钮名称
- [ ] 检查对话框是否被正确识别

**焦点管理测试**：

- [ ] 打开对话框时焦点自动移入
- [ ] 关闭对话框时焦点恢复
- [ ] 用 Tab 键导航流畅

---

## ✅ 执行后的验收标准

### 功能性

1. ✅ 可以只用键盘完成整个游戏流程
2. ✅ 所有交互元素都有 ARIA 标签
3. ✅ 焦点管理正确（打开/关闭对话框）

### 可用性

1. ✅ 焦点样式清晰可见
2. ✅ 键盘快捷键符合直觉
3. ✅ 屏幕阅读器能正确读出界面

### 无副作用

1. ✅ 鼠标操作仍然正常
2. ✅ 触摸操作仍然正常
3. ✅ 无新增 Bug

---

## 💡 额外好处

### 1. 提升非障碍用户体验

很多普通用户也喜欢键盘快捷键：

- ✅ 程序员习惯用键盘
- ✅ 玩视觉小说时可以一只手吃东西、一只手按空格
- ✅ 更快速的操作

### 2. 移动端也受益

虽然是为键盘设计，但：

- ✅ ARIA 标签帮助移动端屏幕阅读器
- ✅ 焦点管理改善了触摸体验

### 3. 符合标准

- ✅ 符合 WCAG 2.1（Web 内容可访问性指南）
- ✅ 体现开发者的专业性和责任心

---

## 🎯 总结

### 这个任务值得做吗？

| 对比项 | 评分 | 说明 |
|--------|------|------|
| 用户体验提升 | ⭐⭐⭐⭐⭐ | 显著提升 |
| 实施难度 | ⭐⭐⭐ | 中等 |
| 时间投入 | ⭐⭐⭐ | 约1小时 |
| 风险 | ⭐⭐ | 较低 |
| **推荐度** | **⭐⭐⭐⭐** | **值得做** |

### 我的建议

**如果你有 1 小时**：强烈建议做！

- 用户体验提升明显
- 体现专业性
- 中等难度，可以学到新知识

**如果时间紧张**：可以先做一部分

- 最有价值：键盘导航（Space/Enter 推进对话）
- 次要：ARIA 标签
- 可选：高级焦点管理

---

## ❓ 你的决定

看完详细解释后，你希望：

1. **立即开始执行任务 7** - 我现在就开始（约 1 小时）
2. **只做核心部分** - 只添加键盘导航（约 30 分钟）
3. **还有疑问** - 让我进一步解释某个部分
4. **暂时不做** - 想先做其他事情

请告诉我你的选择！🚀

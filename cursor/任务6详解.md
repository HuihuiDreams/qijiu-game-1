# 任务 6 详解：提取魔法数字和字符串

## 🎯 任务目标

将代码中散落的"魔法数字"（hard-coded 的数字和字符串）提取到一个集中的 `CONSTANTS` 对象中，让代码更易维护和理解。

---

## 📖 什么是魔法数字？

### ❌ 坏例子（当前代码）

```javascript
// 这个 500 是什么？为什么是 500？
setTimeout(onLoadComplete, 500);

// 这个 80 代表什么？
const delay = 500 + text.length * 80;

// 这个字符串重复出现在多处，容易拼写错误
localStorage.setItem('qijiu_read_text', data);
localStorage.getItem('qijiu_read_text');
```

### ✅ 好例子（改进后）

```javascript
// 清晰明确：淡入淡出动画的持续时间
setTimeout(onLoadComplete, CONSTANTS.ANIMATION.FADE_DURATION);

// 清晰明确：基础延迟 + 每个字符的延迟
const delay = CONSTANTS.AUTO_MODE_DELAY.BASE + 
              text.length * CONSTANTS.AUTO_MODE_DELAY.PER_CHAR;

// 集中管理，不会拼写错误
localStorage.setItem(CONSTANTS.STORAGE_KEYS.READ_TEXT, data);
localStorage.getItem(CONSTANTS.STORAGE_KEYS.READ_TEXT);
```

---

## 📝 具体实施步骤

### 步骤 1：创建 CONSTANTS 对象（5分钟）

在 `index.html` 的 JavaScript 部分（大约第 455 行，`ASSETS` 定义之前）添加：

```javascript
// --- 常量配置 ---
const CONSTANTS = {
    // 打字机效果速度
    TYPING_SPEED: {
        MIN: 10,        // 最快速度（毫秒/字符）
        MAX: 80,        // 最慢速度
        DEFAULT: 30     // 默认速度
    },
    
    // 自动模式延迟时间
    AUTO_MODE_DELAY: {
        BASE: 500,      // 基础延迟（毫秒）
        PER_CHAR: 80    // 每个字符增加的延迟
    },
    
    // localStorage 存储键名
    STORAGE_KEYS: {
        AUTO_SAVE: 'qijiu_auto_save',
        SAVE_SLOT_PREFIX: 'qijiu_save_slot_',
        READ_TEXT: 'qijiu_read_text',
        UNLOCKED_ENDINGS: 'qijiu_unlocked_endings',
        UNLOCKED_CHAPTERS: 'qijiu_unlocked_chapters',
        SETTINGS: 'qijiu_settings'
    },
    
    // 动画持续时间
    ANIMATION: {
        FADE_DURATION: 500,     // 淡入淡出
        SHAKE_DURATION: 600,    // 震动效果
        RHYTHM_DURATION: 500,   // 节奏震动
        PRELOADER_DELAY: 500    // 预加载完成后的延迟
    }
};
```

**为什么这样组织？**

- 按功能分类（速度、延迟、存储、动画）
- 每个常量都有清晰的注释
- 嵌套结构方便管理相关常量

---

### 步骤 2：替换代码中的魔法数字（10-15分钟）

我会在代码中搜索并替换所有魔法数字。以下是主要修改点：

#### 修改点 1：打字机速度

**当前代码**（某个地方）:

```javascript
const speed = textSpeed; // textSpeed 范围是 10-80，但不清楚
```

**改进后**:

```javascript
const speed = Math.max(
    CONSTANTS.TYPING_SPEED.MAX - textSpeed,
    CONSTANTS.TYPING_SPEED.MIN
);
```

#### 修改点 2：自动模式延迟

**当前代码**（大约第 1427 行）:

```javascript
const delay = 500 + (currentLine?.text?.length || 0) * 80;
```

**改进后**:

```javascript
const delay = CONSTANTS.AUTO_MODE_DELAY.BASE + 
              (currentLine?.text?.length || 0) * CONSTANTS.AUTO_MODE_DELAY.PER_CHAR;
```

#### 修改点 3：动画持续时间

**当前代码**（预加载器，约第 840 行）:

```javascript
setTimeout(onLoadComplete, 500);
```

**改进后**:

```javascript
setTimeout(onLoadComplete, CONSTANTS.ANIMATION.PRELOADER_DELAY);
```

#### 修改点 4：所有 localStorage 键名

**当前代码**（多处）:

```javascript
const READ_TEXT_KEY = 'qijiu_read_text';
const AUTO_SAVE_KEY = 'qijiu_auto_save';
// ... 等等
```

**改进后**:

```javascript
const READ_TEXT_KEY = CONSTANTS.STORAGE_KEYS.READ_TEXT;
const AUTO_SAVE_KEY = CONSTANTS.STORAGE_KEYS.AUTO_SAVE;
```

---

### 步骤 3：测试验证（5分钟）

测试内容：

- ✅ 游戏启动正常
- ✅ 文本打字效果正常
- ✅ 自动模式延迟正常
- ✅ 存档/读档功能正常
- ✅ 动画效果正常

---

## 🎁 完成后的好处

### 1. 易于理解 📖

**改进前**:

```javascript
setTimeout(() => doSomething(), 500);
// ❓ 500 是什么？为什么是 500？
```

**改进后**:

```javascript
setTimeout(() => doSomething(), CONSTANTS.ANIMATION.FADE_DURATION);
// ✅ 清楚明确：淡入淡出动画的持续时间
```

### 2. 易于维护 🔧

**想要调整自动播放速度？**

**改进前**:

```javascript
// 需要在代码中搜索所有 500 和 80，容易漏掉
const delay1 = 500 + text.length * 80;  // 这里
const delay2 = 500 + otherText.length * 80;  // 那里
```

**改进后**:

```javascript
// 只需修改一个地方！
const CONSTANTS = {
    AUTO_MODE_DELAY: {
        BASE: 600,      // 改！从 500 → 600
        PER_CHAR: 100   // 改！从 80 → 100
    }
};
```

### 3. 避免拼写错误 ✏️

**改进前**:

```javascript
localStorage.setItem('qijiu_read_text', data);
// ... 100 行后...
const saved = localStorage.getItem('qijiu_raed_text');  // ❌ 拼写错误！
```

**改进后**:

```javascript
localStorage.setItem(CONSTANTS.STORAGE_KEYS.READ_TEXT, data);
// ... 100 行后...
const saved = localStorage.getItem(CONSTANTS.STORAGE_KEYS.READ_TEXT);  // ✅
```

### 4. 方便实验和调优 🎮

想让游戏更快？

```javascript
const CONSTANTS = {
    AUTO_MODE_DELAY: {
        BASE: 300,      // 减少延迟
        PER_CHAR: 50    // 加快速度
    }
};
```

想让动画更流畅？

```javascript
const CONSTANTS = {
    ANIMATION: {
        FADE_DURATION: 800,  // 更慢的淡入淡出
    }
};
```

---

## 📊 预计工作量

| 步骤 | 工作内容 | 预计时间 |
|------|---------|---------|
| 1 | 创建 CONSTANTS 对象 | 5 分钟 |
| 2 | 替换魔法数字（自动搜索+替换）| 10-15 分钟 |
| 3 | 测试验证 | 5 分钟 |
| **总计** | | **20-25 分钟** |

---

## ⚠️ 注意事项

### 不会改变的内容

- ✅ 游戏功能完全一致
- ✅ 用户体验完全一致
- ✅ 性能完全一致

### 会改变的内容

- ✅ 代码可读性提升
- ✅ 代码可维护性提升
- ✅ 未来调整参数更方便

---

## 🔍 实际代码对比

### 对比 1：预加载器

**改进前**:

```javascript
const Preloader = ({ onLoadComplete }) => {
    // ...
    setTimeout(onLoadComplete, 500);  // ❓ 500？
    // ...
};
```

**改进后**:

```javascript
const Preloader = ({ onLoadComplete }) => {
    // ...
    setTimeout(onLoadComplete, CONSTANTS.ANIMATION.PRELOADER_DELAY);  // ✅ 清晰！
    // ...
};
```

### 对比 2：自动播放

**改进前**:

```javascript
const delay = 500 + text.length * 80;  // ❓ 这些数字从哪来？
```

**改进后**:

```javascript
const delay = CONSTANTS.AUTO_MODE_DELAY.BASE + 
              text.length * CONSTANTS.AUTO_MODE_DELAY.PER_CHAR;  // ✅ 一目了然！
```

### 对比 3：存储键名

**改进前**:

```javascript
// 定义在不同地方，容易不一致
const READ_TEXT_KEY = 'qijiu_read_text';
const AUTO_SAVE_KEY = 'qijiu_auto_save';
// ...
```

**改进后**:

```javascript
// 集中管理，统一来源
const READ_TEXT_KEY = CONSTANTS.STORAGE_KEYS.READ_TEXT;
const AUTO_SAVE_KEY = CONSTANTS.STORAGE_KEYS.AUTO_SAVE;
// ...
```

---

## ✅ 执行后的验收标准

1. **代码中所有魔法数字都被替换** ✅
   - 搜索 `500`、`80`、`30` 等数字时，应该都有明确含义或来自 CONSTANTS

2. **CONSTANTS 对象结构清晰** ✅
   - 有合理的分类
   - 每个常量有注释
   - 命名语义化

3. **功能完全正常** ✅
   - 所有测试通过
   - 无新增 Bug
   - 用户体验无变化

---

## 💡 额外好处

### 未来可扩展

如果以后想添加"难度设置"：

```javascript
const CONSTANTS = {
    DIFFICULTY: {
        EASY: {
            TYPING_SPEED: 60,
            AUTO_DELAY: 800
        },
        NORMAL: {
            TYPING_SPEED: 30,
            AUTO_DELAY: 500
        },
        HARD: {
            TYPING_SPEED: 10,
            AUTO_DELAY: 300
        }
    }
};
```

就可以快速实现！

---

## ❓ 你的决定

看完详细解释后，你希望：

1. **立即开始执行任务 6** - 我现在就开始（推荐）✨
2. **还有疑问** - 让我进一步解释某个部分
3. **先看看其他任务** - 对比一下再决定
4. **暂时不做** - 想先做其他事情

请告诉我你的选择！🚀
